<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minha Empresa - Admin WhatsBenemax</title>
  <link rel="stylesheet" href="/css/app.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>

<div class="app-container">
  <div id="sidebarContainer"></div>
  <div id="headerContainer"></div>

  <main class="app-main">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="page-title">Minha Empresa</h1>
        <p class="page-subtitle">Gerencie informações, plano e uso</p>
      </div>
      <button class="btn btn-primary" onclick="Empresa.openEditModal()">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
        </svg>
        Editar Empresa
      </button>
    </div>

    <!-- Informações da Empresa -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <div class="card lg:col-span-2">
        <h3 class="font-bold mb-4">Informações da Empresa</h3>
        <div class="grid grid-cols-2 gap-4" id="companyInfo">
          <div class="col-span-2 text-center text-gray-500 py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
            <p class="mt-2">Carregando...</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 class="font-bold mb-4">Plano Atual</h3>
        <div id="planInfo">
          <div class="text-center text-gray-500 py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
            <p class="mt-2">Carregando...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Uso e Limites -->
    <div class="card mb-6">
      <h3 class="font-bold mb-4">Uso e Limites</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="usageStats">
        <div class="text-center text-gray-500">Carregando...</div>
      </div>
    </div>

    <!-- Créditos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <div class="card">
        <h3 class="font-bold mb-4">Créditos</h3>
        <div id="creditsInfo">
          <div class="text-center text-gray-500 py-4">Carregando...</div>
        </div>
      </div>

      <div class="card">
        <h3 class="font-bold mb-4">Transações Recentes</h3>
        <div id="transactionsInfo">
          <div class="text-center text-gray-500 py-4">Carregando...</div>
        </div>
      </div>
    </div>

    <!-- White-label (se disponível) -->
    <div class="card" id="whitelabelSection" style="display: none;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold">Configurações White-label</h3>
        <button class="btn btn-outline" onclick="Empresa.openWhitelabelModal()">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
          Editar
        </button>
      </div>
      <div class="grid grid-cols-2 gap-4" id="whitelabelInfo">
        <div class="text-center text-gray-500 py-4">Carregando...</div>
      </div>
    </div>
  </main>
</div>

<script src="/js/utils.js"></script>
<script src="/js/admin-template.js"></script>
<script src="/js/modal.js"></script>
<script>
document.getElementById('sidebarContainer').innerHTML = AdminTemplate.renderSidebar('empresas');
document.getElementById('headerContainer').innerHTML = AdminTemplate.renderHeader();
AdminTemplate.init('empresas');

const Empresa = {
  company: null,
  plan: null,
  usage: null,
  credits: null,
  transactions: [],

  async init() {
    await Promise.all([
      this.loadCompany(),
      this.loadPlan(),
      this.loadUsage(),
      this.loadCredits(),
      this.loadTransactions()
    ]);
  },

  async loadCompany() {
    try {
      const response = await API.get('/api/empresa');
      this.company = response.empresa || response;
      this.renderCompanyInfo();
    } catch (error) {
      console.error('[Empresa] Erro ao carregar empresa:', error);
      Toast.error('Erro ao carregar informações da empresa');
    }
  },

  async loadPlan() {
    try {
      const response = await API.get('/api/empresa/plano');
      this.plan = response.plano_atual || response;
      this.renderPlanInfo();

      // Mostrar seção white-label se disponível
      if (this.company?.whitelabel_ativo) {
        document.getElementById('whitelabelSection').style.display = 'block';
        this.renderWhitelabelInfo();
      }
    } catch (error) {
      console.error('[Empresa] Erro ao carregar plano:', error);
    }
  },

  async loadUsage() {
    try {
      const response = await API.get('/api/empresa/uso');
      this.usage = response;
      this.renderUsageStats();
    } catch (error) {
      console.error('[Empresa] Erro ao carregar uso:', error);
    }
  },

  async loadCredits() {
    try {
      const response = await API.get('/api/empresa/creditos');
      this.credits = response;
      this.renderCreditsInfo();
    } catch (error) {
      console.error('[Empresa] Erro ao carregar créditos:', error);
    }
  },

  async loadTransactions() {
    try {
      const response = await API.get('/api/empresa/transacoes?limite=5');
      this.transactions = response.transacoes || [];
      this.renderTransactions();
    } catch (error) {
      console.error('[Empresa] Erro ao carregar transações:', error);
    }
  },

  renderCompanyInfo() {
    const c = this.company;
    document.getElementById('companyInfo').innerHTML = `
      <div>
        <label class="block text-sm font-medium text-gray-500 mb-1">Nome</label>
        <p class="font-semibold">${c.nome || '-'}</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500 mb-1">Email</label>
        <p>${c.email || '-'}</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500 mb-1">Telefone</label>
        <p>${c.telefone || '-'}</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500 mb-1">Documento</label>
        <p>${c.documento || '-'}</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500 mb-1">Cidade/Estado</label>
        <p>${c.cidade || '-'} / ${c.estado || '-'}</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500 mb-1">CEP</label>
        <p>${c.cep || '-'}</p>
      </div>
      <div class="col-span-2">
        <label class="block text-sm font-medium text-gray-500 mb-1">Endereço</label>
        <p>${c.endereco || '-'}</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500 mb-1">Status</label>
        <span class="badge ${this.getStatusClass(c.status)}">
          ${this.getStatusLabel(c.status)}
        </span>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500 mb-1">Criada em</label>
        <p>${this.formatDate(c.criado_em)}</p>
      </div>
    `;
  },

  renderPlanInfo() {
    const p = this.plan;
    document.getElementById('planInfo').innerHTML = `
      <div class="mb-4">
        <h4 class="text-2xl font-bold text-purple-600">${p.nome || 'Nenhum plano'}</h4>
        <p class="text-3xl font-bold text-green-600 mt-2">${this.formatCurrency(p.preco_mensal)}<span class="text-sm text-gray-500">/mês</span></p>
      </div>
      <div class="border-t pt-3">
        <p class="text-sm text-gray-500 mb-1">Recursos:</p>
        <ul class="text-sm space-y-1">
          <li>✓ Até ${p.max_usuarios || 0} usuários</li>
          <li>✓ Até ${p.max_instancias || 0} instâncias</li>
          <li>✓ Até ${p.max_contatos || 0} contatos</li>
        </ul>
      </div>
      <div class="mt-4">
        <button class="btn btn-primary w-full" onclick="window.location.href='planos.html'">
          Ver Todos os Planos
        </button>
      </div>
    `;
  },

  renderUsageStats() {
    const { uso, limites, percentual } = this.usage;
    document.getElementById('usageStats').innerHTML = `
      <div>
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium">Usuários</span>
          <span class="text-sm text-gray-500">${uso.usuarios} / ${limites.max_usuarios}</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-purple-600 h-2 rounded-full" style="width: ${percentual.usuarios}%"></div>
        </div>
        <p class="text-xs text-gray-500 mt-1">${percentual.usuarios}% utilizado</p>
      </div>
      <div>
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium">Instâncias</span>
          <span class="text-sm text-gray-500">${uso.instancias} / ${limites.max_instancias}</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentual.instancias}%"></div>
        </div>
        <p class="text-xs text-gray-500 mt-1">${percentual.instancias}% utilizado</p>
      </div>
      <div>
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium">Contatos</span>
          <span class="text-sm text-gray-500">${uso.contatos} / ${limites.max_contatos}</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-green-600 h-2 rounded-full" style="width: ${percentual.contatos}%"></div>
        </div>
        <p class="text-xs text-gray-500 mt-1">${percentual.contatos}% utilizado</p>
      </div>
    `;
  },

  renderCreditsInfo() {
    document.getElementById('creditsInfo').innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm text-gray-500">Saldo de Créditos</span>
        <span class="text-2xl font-bold text-green-600">${this.credits.saldo_creditos || 0}</span>
      </div>
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm text-gray-500">Usados Este Mês</span>
        <span class="text-lg font-semibold text-red-600">${this.credits.creditos_usados_mes || 0}</span>
      </div>
      ${this.credits.creditos_resetam_em ? `
        <div class="text-xs text-gray-500 mt-2">
          Próximo reset: ${this.formatDate(this.credits.creditos_resetam_em)}
        </div>
      ` : ''}
    `;
  },

  renderTransactions() {
    if (this.transactions.length === 0) {
      document.getElementById('transactionsInfo').innerHTML = '<p class="text-center text-gray-500 py-4">Nenhuma transação ainda</p>';
      return;
    }

    document.getElementById('transactionsInfo').innerHTML = `
      <div class="space-y-2">
        ${this.transactions.slice(0, 5).map(t => `
          <div class="flex items-center justify-between border-b pb-2">
            <div>
              <p class="text-sm font-semibold">${t.tipo}</p>
              <p class="text-xs text-gray-500">${this.formatDate(t.criado_em)}</p>
            </div>
            <span class="font-bold ${t.valor > 0 ? 'text-green-600' : 'text-red-600'}">
              ${t.valor > 0 ? '+' : ''}${t.valor}
            </span>
          </div>
        `).join('')}
      </div>
    `;
  },

  renderWhitelabelInfo() {
    const c = this.company;
    document.getElementById('whitelabelInfo').innerHTML = `
      <div>
        <label class="block text-sm font-medium text-gray-500 mb-1">Logo URL</label>
        <p class="text-sm truncate">${c.logo_url || '-'}</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500 mb-1">Domínio Customizado</label>
        <p class="text-sm">${c.dominio_customizado || '-'}</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500 mb-1">Cor Primária</label>
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded border" style="background-color: ${c.cor_primaria || '#8B5CF6'}"></div>
          <p class="text-sm">${c.cor_primaria || '#8B5CF6'}</p>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500 mb-1">Cor Secundária</label>
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded border" style="background-color: ${c.cor_secundaria || '#3B82F6'}"></div>
          <p class="text-sm">${c.cor_secundaria || '#3B82F6'}</p>
        </div>
      </div>
    `;
  },

  openEditModal() {
    Modal.form({
      id: 'modal-edit-company',
      title: 'Editar Empresa',
      size: 'lg',
      data: this.company,
      fields: [
        { name: 'nome', label: 'Nome da Empresa', type: 'text', required: true },
        { name: 'email', label: 'Email', type: 'email', required: true },
        { name: 'telefone', label: 'Telefone', type: 'tel', placeholder: '5511999999999' },
        { name: 'documento', label: 'CNPJ/CPF', type: 'text' },
        { name: 'endereco', label: 'Endereço', type: 'text' },
        { name: 'cidade', label: 'Cidade', type: 'text' },
        { name: 'estado', label: 'Estado', type: 'text', placeholder: 'SP' },
        { name: 'cep', label: 'CEP', type: 'text', placeholder: '00000-000' }
      ],
      onSubmit: async (data) => {
        try {
          Modal.loading('Atualizando empresa...');

          await API.put('/api/empresa', data);

          Modal.closeLoading();
          Toast.success('Empresa atualizada com sucesso!');
          await this.loadCompany();
        } catch (error) {
          Modal.closeLoading();
          Toast.error(error.message || 'Erro ao atualizar empresa');
          return false;
        }
      }
    });
  },

  openWhitelabelModal() {
    Modal.form({
      id: 'modal-edit-whitelabel',
      title: 'Configurações White-label',
      size: 'md',
      data: this.company,
      fields: [
        { name: 'logo_url', label: 'URL do Logo', type: 'url', placeholder: 'https://...' },
        { name: 'dominio_customizado', label: 'Domínio Customizado', type: 'text', placeholder: 'app.suaempresa.com' },
        { name: 'cor_primaria', label: 'Cor Primária', type: 'color', defaultValue: '#8B5CF6' },
        { name: 'cor_secundaria', label: 'Cor Secundária', type: 'color', defaultValue: '#3B82F6' }
      ],
      onSubmit: async (data) => {
        try {
          Modal.loading('Atualizando white-label...');

          await API.put('/api/empresa/whitelabel', data);

          Modal.closeLoading();
          Toast.success('Configurações atualizadas com sucesso!');
          await this.loadCompany();
          this.renderWhitelabelInfo();
        } catch (error) {
          Modal.closeLoading();
          Toast.error(error.message || 'Erro ao atualizar configurações');
          return false;
        }
      }
    });
  },

  formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(value || 0);
  },

  formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  },

  getStatusClass(status) {
    const classes = {
      ativo: 'badge-success',
      trial: 'badge-warning',
      inativo: 'badge-secondary',
      bloqueado: 'badge-error'
    };
    return classes[status] || 'badge-secondary';
  },

  getStatusLabel(status) {
    const labels = {
      ativo: 'Ativo',
      trial: 'Trial',
      inativo: 'Inativo',
      bloqueado: 'Bloqueado'
    };
    return labels[status] || status;
  }
};

// Inicializar
Empresa.init();
</script>

</body>
</html>
