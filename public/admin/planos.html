<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planos - Admin WhatsBenemax</title>
  <link rel="stylesheet" href="/css/app.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Aplicar dark mode ANTES de renderizar para evitar flash
    if (localStorage.getItem('darkMode') === 'true') {
      document.documentElement.classList.add('dark');
    }
  </script>
</head>
<body>
<script>
  // Transferir classe dark de html para body
  if (document.documentElement.classList.contains('dark')) {
    document.body.classList.add('dark');
    document.documentElement.classList.remove('dark');
  }
</script>

<div class="app-container">
  <div id="sidebarContainer"></div>
  <div id="headerContainer"></div>

  <main class="app-main">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="page-title">Planos</h1>
        <p class="page-subtitle">Escolha o plano ideal para sua empresa</p>
      </div>
    </div>

    <!-- Cards de Planos -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6" id="plansGrid">
      <div class="col-span-3 text-center text-gray-500 py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
        <p class="mt-2">Carregando planos...</p>
      </div>
    </div>

    <!-- Comparação de Planos -->
    <div class="card">
      <h3 class="font-bold mb-4">Comparação de Planos</h3>
      <div class="overflow-x-auto">
        <table class="table" id="comparisonTable">
          <tbody>
            <tr>
              <td colspan="100%" class="text-center text-gray-500 py-8">Carregando...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<script src="/js/utils.js"></script>
<script src="/js/admin-template.js"></script>
<script src="/js/modal.js"></script>
<script>
document.getElementById('sidebarContainer').innerHTML = AdminTemplate.renderSidebar('planos');
document.getElementById('headerContainer').innerHTML = AdminTemplate.renderHeader();
AdminTemplate.init('planos');

const Planos = {
  plans: [],
  comparison: null,
  currentPlanId: null,

  async init() {
    await this.loadCurrentPlan();
    await this.loadPlans();
    await this.loadComparison();
  },

  async loadCurrentPlan() {
    try {
      const response = await API.get('/api/empresa/plano');
      this.currentPlanId = response.plano_atual?.id || null;
    } catch (error) {
      console.error('[Planos] Erro ao carregar plano atual:', error);
    }
  },

  async loadPlans() {
    try {
      const response = await API.get('/api/planos');
      this.plans = response.planos || response || [];
      this.renderPlansGrid();
    } catch (error) {
      console.error('[Planos] Erro ao carregar planos:', error);
      Toast.error('Erro ao carregar planos');
      document.getElementById('plansGrid').innerHTML = `
        <div class="col-span-3 text-center text-red-500 py-8">
          Erro ao carregar planos. Tente novamente.
        </div>
      `;
    }
  },

  async loadComparison() {
    try {
      const response = await API.get('/api/planos/comparar');
      this.comparison = response;
      this.renderComparison();
    } catch (error) {
      console.error('[Planos] Erro ao carregar comparação:', error);
    }
  },

  renderPlansGrid() {
    if (this.plans.length === 0) {
      document.getElementById('plansGrid').innerHTML = `
        <div class="col-span-3 text-center text-gray-500 py-8">
          Nenhum plano disponível no momento.
        </div>
      `;
      return;
    }

    document.getElementById('plansGrid').innerHTML = this.plans.map(plan => {
      const isCurrentPlan = plan.id === this.currentPlanId;
      const isMostPopular = plan.nome.toLowerCase().includes('profissional') ||
                             plan.nome.toLowerCase().includes('pro');

      return `
        <div class="card relative ${isMostPopular ? 'border-2 border-purple-600' : ''}">
          ${isMostPopular ? `
            <div class="absolute top-0 right-0 bg-purple-600 text-white px-3 py-1 rounded-bl text-xs font-semibold">
              MAIS POPULAR
            </div>
          ` : ''}
          ${isCurrentPlan ? `
            <div class="absolute top-0 left-0 bg-green-600 text-white px-3 py-1 rounded-br text-xs font-semibold">
              PLANO ATUAL
            </div>
          ` : ''}

          <div class="flex items-center justify-between mb-4 ${isMostPopular || isCurrentPlan ? 'mt-8' : ''}">
            <h3 class="text-xl font-bold">${plan.nome}</h3>
            <span class="badge ${plan.ativo ? 'badge-success' : 'badge-secondary'}">
              ${plan.ativo ? 'Ativo' : 'Inativo'}
            </span>
          </div>

          <div class="mb-4">
            <span class="text-3xl font-bold text-purple-600">${this.formatCurrency(plan.preco_mensal)}</span>
            <span class="text-gray-500">/mês</span>
          </div>

          <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">${plan.descricao || ''}</p>

          <ul class="space-y-2 mb-6 text-sm">
            <li class="flex items-center">
              <svg class="w-4 h-4 text-green-600 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              Até ${plan.max_usuarios} usuários
            </li>
            <li class="flex items-center">
              <svg class="w-4 h-4 text-green-600 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              ${plan.max_instancias} instância${plan.max_instancias > 1 ? 's' : ''} WhatsApp
            </li>
            <li class="flex items-center">
              <svg class="w-4 h-4 text-green-600 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              Até ${this.formatNumber(plan.max_contatos)} contatos
            </li>
            ${this.renderFeatures(plan.funcionalidades)}
          </ul>

          <button class="btn ${isCurrentPlan ? 'btn-outline' : 'btn-primary'} w-full"
                  onclick="${isCurrentPlan ? `Toast.info('Este já é seu plano atual')` : `Planos.viewPlan(${plan.id})`}"
                  ${!plan.ativo ? 'disabled' : ''}>
            ${isCurrentPlan ? 'Plano Atual' : 'Ver Detalhes'}
          </button>
        </div>
      `;
    }).join('');
  },

  renderFeatures(funcionalidades) {
    if (!funcionalidades) return '';

    const features = [];

    if (funcionalidades.agente_ia) {
      features.push(`
        <li class="flex items-center">
          <svg class="w-4 h-4 text-green-600 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Agentes IA
        </li>
      `);
    }

    if (funcionalidades.prospeccao) {
      features.push(`
        <li class="flex items-center">
          <svg class="w-4 h-4 text-green-600 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Prospecção
        </li>
      `);
    }

    if (funcionalidades.crm) {
      features.push(`
        <li class="flex items-center">
          <svg class="w-4 h-4 text-green-600 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          CRM Completo
        </li>
      `);
    }

    if (funcionalidades.integracoes) {
      features.push(`
        <li class="flex items-center">
          <svg class="w-4 h-4 text-green-600 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Integrações
        </li>
      `);
    }

    if (funcionalidades.whitelabel) {
      features.push(`
        <li class="flex items-center">
          <svg class="w-4 h-4 text-green-600 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          White-label
        </li>
      `);
    }

    if (funcionalidades.suporte_prioritario) {
      features.push(`
        <li class="flex items-center">
          <svg class="w-4 h-4 text-green-600 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Suporte Prioritário
        </li>
      `);
    }

    return features.join('');
  },

  renderComparison() {
    if (!this.comparison || !this.comparison.planos || this.comparison.planos.length === 0) {
      document.getElementById('comparisonTable').innerHTML = `
        <tr>
          <td colspan="100%" class="text-center text-gray-500 py-8">
            Nenhum dado de comparação disponível
          </td>
        </tr>
      `;
      return;
    }

    const { caracteristicas, planos } = this.comparison;

    // Header
    let html = `
      <thead>
        <tr>
          <th class="text-left">Recurso</th>
          ${planos.map(p => `<th class="text-center">${p.nome}</th>`).join('')}
        </tr>
      </thead>
      <tbody>
    `;

    // Rows for each characteristic
    caracteristicas.forEach(carac => {
      html += `<tr>`;
      html += `<td class="font-medium">${carac.nome}</td>`;

      planos.forEach(plano => {
        const valor = plano.valores[carac.campo];

        if (carac.tipo === 'boolean') {
          html += `<td class="text-center">`;
          if (valor) {
            html += `<svg class="w-5 h-5 text-green-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>`;
          } else {
            html += `<svg class="w-5 h-5 text-red-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>`;
          }
          html += `</td>`;
        } else if (carac.tipo === 'numero') {
          html += `<td class="text-center font-semibold">${this.formatNumber(valor)}</td>`;
        } else {
          html += `<td class="text-center">${valor || '-'}</td>`;
        }
      });

      html += `</tr>`;
    });

    // Price row
    html += `
      <tr class="border-t-2">
        <td class="font-bold">Preço Mensal</td>
        ${planos.map(p => `
          <td class="text-center font-bold text-green-600">${this.formatCurrency(p.preco_mensal)}</td>
        `).join('')}
      </tr>
    `;

    html += `</tbody>`;

    document.getElementById('comparisonTable').innerHTML = html;
  },

  async viewPlan(planId) {
    try {
      Modal.loading('Carregando detalhes...');

      const response = await API.get(`/api/planos/${planId}`);
      const plan = response.plano || response;

      Modal.closeLoading();

      Modal.view({
        title: plan.nome,
        size: 'md',
        data: {
          'Preço Mensal': this.formatCurrency(plan.preco_mensal),
          'Descrição': plan.descricao || '-',
          'Usuários': plan.max_usuarios,
          'Instâncias WhatsApp': plan.max_instancias,
          'Contatos': this.formatNumber(plan.max_contatos),
          'Agente IA': plan.funcionalidades?.agente_ia ? 'Sim' : 'Não',
          'Prospecção': plan.funcionalidades?.prospeccao ? 'Sim' : 'Não',
          'CRM': plan.funcionalidades?.crm ? 'Sim' : 'Não',
          'Integrações': plan.funcionalidades?.integracoes ? 'Sim' : 'Não',
          'White-label': plan.funcionalidades?.whitelabel ? 'Sim' : 'Não',
          'Suporte': plan.funcionalidades?.suporte_prioritario ? 'Prioritário' : 'Email'
        }
      });
    } catch (error) {
      Modal.closeLoading();
      Toast.error('Erro ao carregar plano');
    }
  },

  formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(value || 0);
  },

  formatNumber(value) {
    if (!value && value !== 0) return '-';
    if (value === -1 || value === 999999 || value >= 100000) return 'Ilimitado';
    return new Intl.NumberFormat('pt-BR').format(value);
  }
};

// Inicializar
Planos.init();
</script>

</body>
</html>
