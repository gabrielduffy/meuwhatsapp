<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prospecção - Admin WhatsBenemax</title>
  <link rel="stylesheet" href="/css/app.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Aplicar dark mode ANTES de renderizar para evitar flash
    if (localStorage.getItem('darkMode') === 'true') {
      document.documentElement.classList.add('dark');
    }
  </script>
</head>
<body>
<script>
  // Transferir classe dark de html para body
  if (document.documentElement.classList.contains('dark')) {
    document.body.classList.add('dark');
    document.documentElement.classList.remove('dark');
  }
</script>

<div class="app-container">
  <div id="sidebarContainer"></div>
  <div id="headerContainer"></div>

  <main class="app-main">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="page-title">Prospecção</h1>
        <p class="page-subtitle">Gerencie campanhas de prospecção via WhatsApp</p>
      </div>
      <button class="btn btn-primary" onclick="Prospeccao.openCreateCampaignModal()">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Nova Campanha
      </button>
    </div>

    <!-- Estatísticas -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-6">
      <div class="card">
        <p class="text-sm text-gray-500 mb-1">Total Campanhas</p>
        <h3 class="text-2xl font-bold text-purple-600" id="statTotal">-</h3>
      </div>
      <div class="card">
        <p class="text-sm text-gray-500 mb-1">Ativas</p>
        <h3 class="text-2xl font-bold text-green-600" id="statAtivas">-</h3>
      </div>
      <div class="card">
        <p class="text-sm text-gray-500 mb-1">Total Leads</p>
        <h3 class="text-2xl font-bold text-blue-600" id="statLeads">-</h3>
      </div>
      <div class="card">
        <p class="text-sm text-gray-500 mb-1">Enviados</p>
        <h3 class="text-2xl font-bold text-yellow-600" id="statEnviados">-</h3>
      </div>
      <div class="card">
        <p class="text-sm text-gray-500 mb-1">Taxa Resposta</p>
        <h3 class="text-2xl font-bold text-green-600" id="statTaxaResposta">0%</h3>
      </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-6">
      <div class="flex gap-3">
        <select id="filterStatus" class="input" onchange="Prospeccao.loadCampaigns()">
          <option value="">Todos os status</option>
          <option value="rascunho">Rascunho</option>
          <option value="agendada">Agendada</option>
          <option value="ativa">Ativa</option>
          <option value="pausada">Pausada</option>
          <option value="concluida">Concluída</option>
          <option value="cancelada">Cancelada</option>
        </select>
      </div>
    </div>

    <!-- Tabela -->
    <div class="card">
      <table class="table">
        <thead>
          <tr>
            <th>Campanha</th>
            <th>Mensagem</th>
            <th>Total Leads</th>
            <th>Enviados</th>
            <th>Respostas</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="campaignsTable">
          <tr>
            <td colspan="7" class="text-center text-gray-500 py-8">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
              <p class="mt-2">Carregando campanhas...</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>
</div>

<script src="/js/utils.js"></script>
<script src="/js/admin-template.js"></script>
<script src="/js/modal.js"></script>
<script>
document.getElementById('sidebarContainer').innerHTML = AdminTemplate.renderSidebar('prospeccao');
document.getElementById('headerContainer').innerHTML = AdminTemplate.renderHeader();
AdminTemplate.init('prospeccao');

const Prospeccao = {
  campaigns: [],

  async init() {
    await this.loadCampaigns();
  },

  async loadCampaigns() {
    try {
      const params = {};
      const statusFilter = document.getElementById('filterStatus')?.value;
      if (statusFilter) params.status = statusFilter;

      const response = await API.get('/api/prospeccao/campanhas', params);
      this.campaigns = response.campanhas || response || [];

      this.renderTable();
      this.updateStats();
    } catch (error) {
      console.error('[Prospecção] Erro ao carregar campanhas:', error);
      Toast.error('Erro ao carregar campanhas');
      document.getElementById('campaignsTable').innerHTML = `
        <tr>
          <td colspan="7" class="text-center text-red-500 py-8">
            Erro ao carregar campanhas. Tente novamente.
          </td>
        </tr>
      `;
    }
  },

  renderTable() {
    const tbody = document.getElementById('campaignsTable');

    if (this.campaigns.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center text-gray-500 py-8">
            Nenhuma campanha encontrada. Crie sua primeira campanha!
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = this.campaigns.map(camp => `
      <tr>
        <td class="font-semibold">${camp.nome || '-'}</td>
        <td class="text-sm max-w-xs truncate">${this.truncateText(camp.mensagem_template, 50)}</td>
        <td>${camp.total_leads || 0}</td>
        <td>${camp.total_enviados || 0}</td>
        <td class="font-semibold text-green-600">${camp.total_respostas || 0}</td>
        <td>
          <span class="badge ${this.getStatusClass(camp.status)}">
            ${this.getStatusLabel(camp.status)}
          </span>
        </td>
        <td>
          <div class="flex gap-2">
            <button class="btn-sm btn-primary" onclick="Prospeccao.viewCampaign(${camp.id})" title="Ver Detalhes">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
            </button>
            ${camp.status === 'rascunho' || camp.status === 'agendada' ? `
              <button class="btn-sm btn-success" onclick="Prospeccao.startCampaign(${camp.id})" title="Iniciar">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </button>
            ` : ''}
            ${camp.status === 'ativa' ? `
              <button class="btn-sm btn-warning" onclick="Prospeccao.pauseCampaign(${camp.id})" title="Pausar">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </button>
            ` : ''}
            ${camp.status === 'pausada' ? `
              <button class="btn-sm btn-success" onclick="Prospeccao.startCampaign(${camp.id})" title="Continuar">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </button>
            ` : ''}
            <button class="btn-sm btn-secondary" onclick="Prospeccao.importLeads(${camp.id})" title="Importar Leads">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
              </svg>
            </button>
            <button class="btn-sm btn-outline" onclick="Prospeccao.openEditCampaignModal(${camp.id})" title="Editar">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
            </button>
            <button class="btn-sm btn-danger" onclick="Prospeccao.deleteCampaign(${camp.id})" title="Excluir">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        </td>
      </tr>
    `).join('');
  },

  updateStats() {
    const total = this.campaigns.length;
    const ativas = this.campaigns.filter(c => c.status === 'ativa').length;
    const totalLeads = this.campaigns.reduce((sum, c) => sum + (c.total_leads || 0), 0);
    const totalEnviados = this.campaigns.reduce((sum, c) => sum + (c.total_enviados || 0), 0);
    const totalRespostas = this.campaigns.reduce((sum, c) => sum + (c.total_respostas || 0), 0);
    const taxaResposta = totalEnviados > 0 ? ((totalRespostas / totalEnviados) * 100).toFixed(1) : 0;

    document.getElementById('statTotal').textContent = total;
    document.getElementById('statAtivas').textContent = ativas;
    document.getElementById('statLeads').textContent = totalLeads;
    document.getElementById('statEnviados').textContent = totalEnviados;
    document.getElementById('statTaxaResposta').textContent = `${taxaResposta}%`;
  },

  openCreateCampaignModal() {
    Modal.form({
      id: 'modal-create-campaign',
      title: 'Criar Nova Campanha',
      size: 'lg',
      fields: [
        { name: 'nome', label: 'Nome da Campanha', type: 'text', required: true, placeholder: 'Ex: Captação B2B Q1' },
        { name: 'descricao', label: 'Descrição', type: 'textarea', placeholder: 'Descrição da campanha' },
        {
          name: 'mensagem_template',
          label: 'Mensagem Template',
          type: 'textarea',
          required: true,
          placeholder: 'Olá {{nome}}! Tudo bem?',
          help: 'Use {{nome}}, {{telefone}} e outras variáveis personalizadas'
        },
        {
          name: 'intervalo_min',
          label: 'Intervalo Mínimo (segundos)',
          type: 'number',
          defaultValue: '30',
          min: 10,
          help: 'Intervalo mínimo entre mensagens'
        },
        {
          name: 'intervalo_max',
          label: 'Intervalo Máximo (segundos)',
          type: 'number',
          defaultValue: '60',
          min: 10,
          help: 'Intervalo máximo entre mensagens'
        },
        { name: 'horario_inicio', label: 'Horário Início', type: 'time', defaultValue: '09:00' },
        { name: 'horario_fim', label: 'Horário Fim', type: 'time', defaultValue: '18:00' }
      ],
      onSubmit: async (data) => {
        try {
          Modal.loading('Criando campanha...');

          await API.post('/api/prospeccao/campanhas', data);

          Modal.closeLoading();
          Toast.success('Campanha criada com sucesso!');
          await this.loadCampaigns();
        } catch (error) {
          Modal.closeLoading();
          Toast.error(error.message || 'Erro ao criar campanha');
          return false;
        }
      }
    });
  },

  async openEditCampaignModal(campaignId) {
    try {
      Modal.loading('Carregando campanha...');

      const response = await API.get(`/api/prospeccao/campanhas/${campaignId}`);
      const campaign = response.campanha || response;

      Modal.closeLoading();

      Modal.form({
        id: 'modal-edit-campaign',
        title: 'Editar Campanha',
        size: 'lg',
        data: campaign,
        fields: [
          { name: 'nome', label: 'Nome da Campanha', type: 'text', required: true },
          { name: 'descricao', label: 'Descrição', type: 'textarea' },
          { name: 'mensagem_template', label: 'Mensagem Template', type: 'textarea', required: true },
          { name: 'intervalo_min', label: 'Intervalo Mínimo (segundos)', type: 'number', min: 10 },
          { name: 'intervalo_max', label: 'Intervalo Máximo (segundos)', type: 'number', min: 10 },
          { name: 'horario_inicio', label: 'Horário Início', type: 'time' },
          { name: 'horario_fim', label: 'Horário Fim', type: 'time' }
        ],
        onSubmit: async (data) => {
          try {
            Modal.loading('Atualizando campanha...');

            await API.put(`/api/prospeccao/campanhas/${campaignId}`, data);

            Modal.closeLoading();
            Toast.success('Campanha atualizada com sucesso!');
            await this.loadCampaigns();
          } catch (error) {
            Modal.closeLoading();
            Toast.error(error.message || 'Erro ao atualizar campanha');
            return false;
          }
        }
      });
    } catch (error) {
      Modal.closeLoading();
      Toast.error('Erro ao carregar campanha');
    }
  },

  async viewCampaign(campaignId) {
    try {
      Modal.loading('Carregando detalhes...');

      const [campaignResponse, statsResponse, leadsResponse] = await Promise.all([
        API.get(`/api/prospeccao/campanhas/${campaignId}`),
        API.get(`/api/prospeccao/campanhas/${campaignId}/estatisticas`).catch(() => ({})),
        API.get(`/api/prospeccao/campanhas/${campaignId}/leads?limite=5`).catch(() => ({ leads: [] }))
      ]);

      const campaign = campaignResponse.campanha || campaignResponse;
      const stats = statsResponse;
      const leads = leadsResponse.leads || [];

      Modal.closeLoading();

      const leadsHTML = leads.length > 0
        ? leads.map(l => `
            <div class="border-b pb-2 mb-2">
              <p class="text-sm font-semibold">${l.nome || 'Sem nome'} - ${l.telefone}</p>
              <p class="text-xs text-gray-500">Status: ${this.getLeadStatusLabel(l.status)}</p>
            </div>
          `).join('')
        : '<p class="text-gray-500 text-sm">Nenhum lead cadastrado ainda</p>';

      Modal.render({
        id: 'modal-view-campaign',
        title: campaign.nome,
        size: 'lg',
        content: `
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-500 mb-1">Descrição</label>
            <p>${campaign.descricao || '-'}</p>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-500 mb-1">Mensagem Template</label>
            <p class="bg-gray-100 dark:bg-gray-700 p-3 rounded text-sm">${campaign.mensagem_template || '-'}</p>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-500 mb-1">Status</label>
            <span class="badge ${this.getStatusClass(campaign.status)}">
              ${this.getStatusLabel(campaign.status)}
            </span>
          </div>
          <div class="grid grid-cols-4 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-500 mb-1">Total Leads</label>
              <p class="text-2xl font-bold text-purple-600">${campaign.total_leads || 0}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-500 mb-1">Enviados</label>
              <p class="text-2xl font-bold text-blue-600">${campaign.total_enviados || 0}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-500 mb-1">Respostas</label>
              <p class="text-2xl font-bold text-green-600">${campaign.total_respostas || 0}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-500 mb-1">Erros</label>
              <p class="text-2xl font-bold text-red-600">${campaign.total_erros || 0}</p>
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-500 mb-2">Últimos Leads</label>
            ${leadsHTML}
          </div>
        `,
        buttons: [
          { text: 'Ver Todos os Leads', class: 'btn btn-primary', onClick: () => { Modal.close('modal-view-campaign'); this.viewLeads(campaignId); } },
          { text: 'Fechar', class: 'btn btn-outline', onClick: () => Modal.close('modal-view-campaign') }
        ]
      });

      Modal.open('modal-view-campaign');
    } catch (error) {
      Modal.closeLoading();
      Toast.error('Erro ao carregar campanha');
    }
  },

  async viewLeads(campaignId) {
    try {
      Modal.loading('Carregando leads...');

      const response = await API.get(`/api/prospeccao/campanhas/${campaignId}/leads?limite=100`);
      const leads = response.leads || [];

      Modal.closeLoading();

      const leadsHTML = leads.length > 0
        ? `
          <table class="table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Telefone</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${leads.map(l => `
                <tr>
                  <td>${l.nome || 'Sem nome'}</td>
                  <td>${l.telefone}</td>
                  <td>
                    <span class="badge ${this.getLeadStatusBadge(l.status)}">
                      ${this.getLeadStatusLabel(l.status)}
                    </span>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `
        : '<p class="text-gray-500 text-center py-8">Nenhum lead cadastrado ainda</p>';

      Modal.render({
        id: 'modal-view-leads',
        title: `Leads da Campanha (${leads.length})`,
        size: 'lg',
        content: `<div class="max-h-96 overflow-y-auto">${leadsHTML}</div>`,
        buttons: [
          { text: 'Fechar', class: 'btn btn-outline', onClick: () => Modal.close('modal-view-leads') }
        ]
      });

      Modal.open('modal-view-leads');
    } catch (error) {
      Modal.closeLoading();
      Toast.error('Erro ao carregar leads');
    }
  },

  async startCampaign(campaignId) {
    Modal.confirm({
      title: 'Iniciar Campanha',
      message: 'Deseja iniciar esta campanha de prospecção?',
      confirmText: 'Sim, Iniciar',
      onConfirm: async () => {
        try {
          await API.post(`/api/prospeccao/campanhas/${campaignId}/iniciar`);
          Toast.success('Campanha iniciada com sucesso!');
          await this.loadCampaigns();
        } catch (error) {
          Toast.error(error.message || 'Erro ao iniciar campanha');
        }
      }
    });
  },

  async pauseCampaign(campaignId) {
    Modal.confirm({
      title: 'Pausar Campanha',
      message: 'Deseja pausar esta campanha?',
      confirmText: 'Sim, Pausar',
      danger: true,
      onConfirm: async () => {
        try {
          await API.post(`/api/prospeccao/campanhas/${campaignId}/pausar`);
          Toast.success('Campanha pausada com sucesso!');
          await this.loadCampaigns();
        } catch (error) {
          Toast.error(error.message || 'Erro ao pausar campanha');
        }
      }
    });
  },

  async deleteCampaign(campaignId) {
    Modal.confirm({
      title: 'Excluir Campanha',
      message: 'Tem certeza que deseja excluir esta campanha? Esta ação não pode ser desfeita.',
      confirmText: 'Excluir',
      danger: true,
      onConfirm: async () => {
        try {
          await API.delete(`/api/prospeccao/campanhas/${campaignId}`);
          Toast.success('Campanha excluída com sucesso!');
          await this.loadCampaigns();
        } catch (error) {
          Toast.error(error.message || 'Erro ao excluir campanha');
        }
      }
    });
  },

  importLeads(campaignId) {
    Modal.form({
      id: 'modal-import-leads',
      title: 'Importar Leads',
      size: 'md',
      fields: [
        {
          name: 'leads_csv',
          label: 'Lista de Leads (CSV)',
          type: 'textarea',
          required: true,
          placeholder: 'nome,telefone\nJoão Silva,5511999999999\nMaria Santos,5511888888888',
          help: 'Formato: nome,telefone (um por linha)'
        }
      ],
      submitText: 'Importar',
      onSubmit: async (data) => {
        try {
          Modal.loading('Importando leads...');

          // Parse CSV
          const lines = data.leads_csv.trim().split('\n');
          const leads = [];

          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line || line.startsWith('nome,')) continue; // Skip header

            const [nome, telefone] = line.split(',').map(s => s.trim());
            if (telefone) {
              leads.push({ nome: nome || 'Sem nome', telefone });
            }
          }

          if (leads.length === 0) {
            Modal.closeLoading();
            Toast.error('Nenhum lead válido encontrado');
            return false;
          }

          const response = await API.post(`/api/prospeccao/campanhas/${campaignId}/importar`, {
            leads,
            nomeArquivo: 'importacao_manual.csv'
          });

          Modal.closeLoading();
          Toast.success(`${response.importados || leads.length} leads importados com sucesso!`);
          await this.loadCampaigns();
        } catch (error) {
          Modal.closeLoading();
          Toast.error(error.message || 'Erro ao importar leads');
          return false;
        }
      }
    });
  },

  truncateText(text, length) {
    if (!text) return '-';
    return text.length > length ? text.substring(0, length) + '...' : text;
  },

  getStatusClass(status) {
    const classes = {
      rascunho: 'badge-secondary',
      agendada: 'badge-warning',
      ativa: 'badge-success',
      pausada: 'badge-warning',
      concluida: 'badge-secondary',
      cancelada: 'badge-error'
    };
    return classes[status] || 'badge-secondary';
  },

  getStatusLabel(status) {
    const labels = {
      rascunho: 'Rascunho',
      agendada: 'Agendada',
      ativa: 'Ativa',
      pausada: 'Pausada',
      concluida: 'Concluída',
      cancelada: 'Cancelada'
    };
    return labels[status] || status;
  },

  getLeadStatusLabel(status) {
    const labels = {
      pendente: 'Pendente',
      enviado: 'Enviado',
      respondido: 'Respondido',
      erro: 'Erro',
      convertido: 'Convertido'
    };
    return labels[status] || status;
  },

  getLeadStatusBadge(status) {
    const classes = {
      pendente: 'badge-secondary',
      enviado: 'badge-warning',
      respondido: 'badge-success',
      erro: 'badge-error',
      convertido: 'badge-success'
    };
    return classes[status] || 'badge-secondary';
  }
};

// Inicializar
Prospeccao.init();
</script>

</body>
</html>
