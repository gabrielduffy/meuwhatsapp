<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM - Admin WhatsBenemax</title>
  <link rel="stylesheet" href="/css/app.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Aplicar dark mode ANTES de renderizar para evitar flash
    if (localStorage.getItem('darkMode') === 'true') {
      document.documentElement.classList.add('dark');
    }
  </script>
</head>
<body>
<script>
  // Transferir classe dark de html para body
  if (document.documentElement.classList.contains('dark')) {
    document.body.classList.add('dark');
    document.documentElement.classList.remove('dark');
  }
</script>

<div class="app-container">
  <div id="sidebarContainer"></div>
  <div id="headerContainer"></div>

  <main class="app-main">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="page-title">CRM - Gest√£o de Vendas</h1>
        <p class="page-subtitle">Gerencie funis, negocia√ß√µes e tarefas</p>
      </div>
      <div class="flex gap-2">
        <button class="btn btn-outline" onclick="CRM.showTab('visao-geral')">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          Vis√£o Geral
        </button>
        <button class="btn btn-outline" onclick="CRM.showTab('funis')">Funis</button>
        <button class="btn btn-outline" onclick="CRM.showTab('negociacoes')">Negocia√ß√µes</button>
        <button class="btn btn-primary" onclick="CRM.openCreateDealModal()">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Nova Negocia√ß√£o
        </button>
      </div>
    </div>

    <!-- Estat√≠sticas Gerais -->
    <div id="statsSection" class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-6">
      <div class="card">
        <p class="text-sm text-gray-500 mb-1">Total Negocia√ß√µes</p>
        <h3 class="text-2xl font-bold text-purple-600" id="statTotal">-</h3>
      </div>
      <div class="card">
        <p class="text-sm text-gray-500 mb-1">Em Aberto</p>
        <h3 class="text-2xl font-bold text-blue-600" id="statAbertas">-</h3>
      </div>
      <div class="card">
        <p class="text-sm text-gray-500 mb-1">Ganhas</p>
        <h3 class="text-2xl font-bold text-green-600" id="statGanhas">-</h3>
      </div>
      <div class="card">
        <p class="text-sm text-gray-500 mb-1">Valor Total</p>
        <h3 class="text-2xl font-bold text-yellow-600" id="statValorTotal">R$ 0</h3>
      </div>
      <div class="card">
        <p class="text-sm text-gray-500 mb-1">Taxa Convers√£o</p>
        <h3 class="text-2xl font-bold text-green-600" id="statTaxaConversao">0%</h3>
      </div>
    </div>

    <!-- Tab: Vis√£o Geral -->
    <div id="tab-visao-geral" class="tab-content">
      <div class="card">
        <h3 class="font-bold mb-4">Negocia√ß√µes Recentes</h3>
        <table class="table">
          <thead>
            <tr>
              <th>T√≠tulo</th>
              <th>Contato</th>
              <th>Valor</th>
              <th>Funil/Etapa</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="recentDealsTable">
            <tr>
              <td colspan="6" class="text-center text-gray-500 py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                <p class="mt-2">Carregando...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tab: Funis -->
    <div id="tab-funis" class="tab-content hidden">
      <div class="flex justify-between mb-4">
        <h3 class="font-bold text-lg">Funis de Vendas</h3>
        <button class="btn btn-primary" onclick="CRM.openCreateFunnelModal()">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Novo Funil
        </button>
      </div>
      <div class="card">
        <table class="table">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Etapas</th>
              <th>Negocia√ß√µes</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="funnelsTable">
            <tr>
              <td colspan="5" class="text-center text-gray-500 py-8">Carregando...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tab: Negocia√ß√µes -->
    <div id="tab-negociacoes" class="tab-content hidden">
      <div class="flex justify-between mb-4">
        <div class="flex gap-2">
          <select id="filterFunil" class="input" onchange="CRM.loadDeals()">
            <option value="">Todos os funis</option>
          </select>
          <select id="filterStatus" class="input" onchange="CRM.loadDeals()">
            <option value="">Todos os status</option>
            <option value="aberta">Aberta</option>
            <option value="ganha">Ganha</option>
            <option value="perdida">Perdida</option>
          </select>
        </div>
      </div>
      <div class="card">
        <table class="table">
          <thead>
            <tr>
              <th>T√≠tulo</th>
              <th>Contato</th>
              <th>Valor</th>
              <th>Funil/Etapa</th>
              <th>Prioridade</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="dealsTable">
            <tr>
              <td colspan="7" class="text-center text-gray-500 py-8">Carregando...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<script src="/js/utils.js"></script>
<script src="/js/admin-template.js"></script>
<script src="/js/modal.js"></script>
<script>
document.getElementById('sidebarContainer').innerHTML = AdminTemplate.renderSidebar('crm');
document.getElementById('headerContainer').innerHTML = AdminTemplate.renderHeader();
AdminTemplate.init('crm');

const CRM = {
  funnels: [],
  deals: [],
  stats: {},
  currentTab: 'visao-geral',

  async init() {
    await this.loadFunnels();
    await this.loadDeals();
    await this.loadStats();
    this.populateFunnelFilter();
  },

  showTab(tab) {
    this.currentTab = tab;
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.getElementById(`tab-${tab}`).classList.remove('hidden');
  },

  async loadFunnels() {
    try {
      const response = await API.get('/api/crm/funis');
      this.funnels = response.funis || response || [];
      this.renderFunnelsTable();
    } catch (error) {
      console.error('[CRM] Erro ao carregar funis:', error);
      Toast.error('Erro ao carregar funis');
    }
  },

  async loadDeals() {
    try {
      const params = {};
      const funilFilter = document.getElementById('filterFunil')?.value;
      const statusFilter = document.getElementById('filterStatus')?.value;

      if (funilFilter) params.funil_id = funilFilter;
      if (statusFilter) params.status = statusFilter;

      const response = await API.get('/api/crm/negociacoes', params);
      this.deals = response.negociacoes || response || [];
      this.renderDealsTable();
      this.renderRecentDealsTable();
    } catch (error) {
      console.error('[CRM] Erro ao carregar negocia√ß√µes:', error);
      Toast.error('Erro ao carregar negocia√ß√µes');
    }
  },

  async loadStats() {
    try {
      const response = await API.get('/api/crm/estatisticas');
      this.stats = response;
      this.updateStats();
    } catch (error) {
      console.error('[CRM] Erro ao carregar estat√≠sticas:', error);
      this.stats = {
        total_negociacoes: 0,
        abertas: 0,
        ganhas: 0,
        perdidas: 0,
        valor_total: 0,
        valor_ganho: 0,
        taxa_conversao: 0
      };
      this.updateStats();
    }
  },

  updateStats() {
    document.getElementById('statTotal').textContent = this.stats.total_negociacoes || 0;
    document.getElementById('statAbertas').textContent = this.stats.abertas || 0;
    document.getElementById('statGanhas').textContent = this.stats.ganhas || 0;
    document.getElementById('statValorTotal').textContent = this.formatCurrency(this.stats.valor_total || 0);
    document.getElementById('statTaxaConversao').textContent = `${this.stats.taxa_conversao || 0}%`;
  },

  populateFunnelFilter() {
    const select = document.getElementById('filterFunil');
    if (select) {
      select.innerHTML = '<option value="">Todos os funis</option>' +
        this.funnels.map(f => `<option value="${f.id}">${f.nome}</option>`).join('');
    }
  },

  renderFunnelsTable() {
    const tbody = document.getElementById('funnelsTable');

    if (this.funnels.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center text-gray-500 py-8">
            Nenhum funil encontrado. Crie seu primeiro funil!
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = this.funnels.map(funil => `
      <tr>
        <td class="font-semibold">${funil.nome}</td>
        <td>${funil.total_etapas || 0}</td>
        <td>${funil.total_negociacoes || 0}</td>
        <td>
          <span class="badge ${funil.ativo ? 'badge-success' : 'badge-error'}">
            ${funil.ativo ? 'Ativo' : 'Inativo'}
          </span>
        </td>
        <td>
          <div class="flex gap-2">
            <button class="btn-sm btn-primary" onclick="CRM.viewFunnel(${funil.id})" title="Ver Detalhes">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
            </button>
            <button class="btn-sm btn-outline" onclick="CRM.openEditFunnelModal(${funil.id})" title="Editar">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
            </button>
            <button class="btn-sm btn-danger" onclick="CRM.deleteFunnel(${funil.id})" title="Excluir">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        </td>
      </tr>
    `).join('');
  },

  renderDealsTable() {
    const tbody = document.getElementById('dealsTable');

    if (this.deals.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center text-gray-500 py-8">
            Nenhuma negocia√ß√£o encontrada.
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = this.deals.map(deal => `
      <tr>
        <td class="font-semibold">${deal.titulo}</td>
        <td class="text-sm">${deal.contato_nome || '-'}</td>
        <td class="font-semibold">${this.formatCurrency(deal.valor)}</td>
        <td class="text-sm">${deal.funil_nome || '-'} / ${deal.etapa_nome || '-'}</td>
        <td>
          <span class="badge ${this.getPriorityClass(deal.prioridade)}">
            ${this.getPriorityLabel(deal.prioridade)}
          </span>
        </td>
        <td>
          <span class="badge ${this.getStatusClass(deal.status)}">
            ${this.getStatusLabel(deal.status)}
          </span>
        </td>
        <td>
          <div class="flex gap-2">
            <button class="btn-sm btn-primary" onclick="CRM.viewDeal(${deal.id})" title="Ver Detalhes">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
            </button>
            ${deal.status === 'aberta' ? `
              <button class="btn-sm btn-success" onclick="CRM.winDeal(${deal.id})" title="Ganhar">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </button>
              <button class="btn-sm btn-danger" onclick="CRM.loseDeal(${deal.id})" title="Perder">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </button>
            ` : ''}
            <button class="btn-sm btn-outline" onclick="CRM.openEditDealModal(${deal.id})" title="Editar">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
            </button>
          </div>
        </td>
      </tr>
    `).join('');
  },

  renderRecentDealsTable() {
    const tbody = document.getElementById('recentDealsTable');
    const recentDeals = this.deals.slice(0, 10);

    if (recentDeals.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center text-gray-500 py-8">
            Nenhuma negocia√ß√£o encontrada.
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = recentDeals.map(deal => `
      <tr>
        <td class="font-semibold">${deal.titulo}</td>
        <td class="text-sm">${deal.contato_nome || '-'}</td>
        <td class="font-semibold">${this.formatCurrency(deal.valor)}</td>
        <td class="text-sm">${deal.funil_nome || '-'} / ${deal.etapa_nome || '-'}</td>
        <td>
          <span class="badge ${this.getStatusClass(deal.status)}">
            ${this.getStatusLabel(deal.status)}
          </span>
        </td>
        <td>
          <button class="btn-sm btn-primary" onclick="CRM.viewDeal(${deal.id})">
            Ver
          </button>
        </td>
      </tr>
    `).join('');
  },

  openCreateFunnelModal() {
    Modal.form({
      id: 'modal-create-funnel',
      title: 'Criar Novo Funil',
      size: 'lg',
      fields: [
        { name: 'nome', label: 'Nome do Funil', type: 'text', required: true, placeholder: 'Ex: Vendas Produto X' },
        { name: 'descricao', label: 'Descri√ß√£o', type: 'textarea', placeholder: 'Descri√ß√£o do funil' },
        { name: 'ativo', label: 'Funil ativo', type: 'checkbox', defaultValue: true }
      ],
      onSubmit: async (data) => {
        try {
          Modal.loading('Criando funil...');

          // Criar funil com etapas padr√£o
          const funilData = {
            ...data,
            etapas: [
              { nome: 'Qualifica√ß√£o', ordem: 1, cor: '#3B82F6' },
              { nome: 'Proposta', ordem: 2, cor: '#8B5CF6' },
              { nome: 'Negocia√ß√£o', ordem: 3, cor: '#F59E0B' },
              { nome: 'Fechamento', ordem: 4, cor: '#10B981' }
            ]
          };

          await API.post('/api/crm/funis', funilData);

          Modal.closeLoading();
          Toast.success('Funil criado com sucesso!');
          await this.loadFunnels();
        } catch (error) {
          Modal.closeLoading();
          Toast.error(error.message || 'Erro ao criar funil');
          return false;
        }
      }
    });
  },

  async openEditFunnelModal(funilId) {
    try {
      Modal.loading('Carregando funil...');

      const response = await API.get(`/api/crm/funis/${funilId}`);
      const funil = response.funil || response;

      Modal.closeLoading();

      Modal.form({
        id: 'modal-edit-funnel',
        title: 'Editar Funil',
        size: 'lg',
        data: funil,
        fields: [
          { name: 'nome', label: 'Nome do Funil', type: 'text', required: true },
          { name: 'descricao', label: 'Descri√ß√£o', type: 'textarea' },
          { name: 'ativo', label: 'Funil ativo', type: 'checkbox' }
        ],
        onSubmit: async (data) => {
          try {
            Modal.loading('Atualizando funil...');

            await API.put(`/api/crm/funis/${funilId}`, data);

            Modal.closeLoading();
            Toast.success('Funil atualizado com sucesso!');
            await this.loadFunnels();
          } catch (error) {
            Modal.closeLoading();
            Toast.error(error.message || 'Erro ao atualizar funil');
            return false;
          }
        }
      });
    } catch (error) {
      Modal.closeLoading();
      Toast.error('Erro ao carregar funil');
    }
  },

  async viewFunnel(funilId) {
    try {
      Modal.loading('Carregando detalhes...');

      const response = await API.get(`/api/crm/funis/${funilId}`);
      const funil = response.funil || response;

      Modal.closeLoading();

      const etapasHTML = funil.etapas && funil.etapas.length > 0
        ? funil.etapas.map(e => `
            <div class="border-l-4 pl-3 mb-2" style="border-color: ${e.cor || '#888'}">
              <strong>${e.nome}</strong> (${e.total_negociacoes || 0} negocia√ß√µes)
            </div>
          `).join('')
        : '<p class="text-gray-500">Nenhuma etapa cadastrada</p>';

      Modal.render({
        id: 'modal-view-funnel',
        title: funil.nome,
        size: 'md',
        content: `
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-500 mb-1">Descri√ß√£o</label>
            <p>${funil.descricao || '-'}</p>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-500 mb-1">Status</label>
            <span class="badge ${funil.ativo ? 'badge-success' : 'badge-error'}">
              ${funil.ativo ? 'Ativo' : 'Inativo'}
            </span>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-500 mb-1">Etapas</label>
            ${etapasHTML}
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-500 mb-1">Total Negocia√ß√µes</label>
              <p class="text-2xl font-bold text-purple-600">${funil.total_negociacoes || 0}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-500 mb-1">Valor Total</label>
              <p class="text-2xl font-bold text-green-600">${this.formatCurrency(funil.valor_total || 0)}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-500 mb-1">Taxa Convers√£o</label>
              <p class="text-2xl font-bold text-yellow-600">${funil.taxa_conversao || 0}%</p>
            </div>
          </div>
        `,
        buttons: [
          { text: 'Fechar', class: 'btn btn-outline', onClick: () => Modal.close('modal-view-funnel') }
        ]
      });

      Modal.open('modal-view-funnel');
    } catch (error) {
      Modal.closeLoading();
      Toast.error('Erro ao carregar funil');
    }
  },

  async deleteFunnel(funilId) {
    Modal.confirm({
      title: 'Excluir Funil',
      message: 'Tem certeza que deseja excluir este funil? Esta a√ß√£o n√£o pode ser desfeita.',
      confirmText: 'Excluir',
      danger: true,
      onConfirm: async () => {
        try {
          await API.delete(`/api/crm/funis/${funilId}`);
          Toast.success('Funil exclu√≠do com sucesso!');
          await this.loadFunnels();
        } catch (error) {
          Toast.error(error.message || 'Erro ao excluir funil');
        }
      }
    });
  },

  openCreateDealModal() {
    if (this.funnels.length === 0) {
      Toast.error('Crie um funil antes de adicionar negocia√ß√µes');
      return;
    }

    Modal.form({
      id: 'modal-create-deal',
      title: 'Criar Nova Negocia√ß√£o',
      size: 'lg',
      fields: [
        { name: 'titulo', label: 'T√≠tulo', type: 'text', required: true, placeholder: 'Ex: Venda Produto X para Cliente Y' },
        { name: 'descricao', label: 'Descri√ß√£o', type: 'textarea', placeholder: 'Detalhes da negocia√ß√£o' },
        {
          name: 'funil_id',
          label: 'Funil',
          type: 'select',
          required: true,
          options: this.funnels.map(f => ({ value: f.id, label: f.nome }))
        },
        { name: 'contato_nome', label: 'Nome do Contato', type: 'text', required: true },
        { name: 'contato_telefone', label: 'Telefone do Contato', type: 'tel', placeholder: '5511999999999' },
        { name: 'valor', label: 'Valor (R$)', type: 'number', defaultValue: '0', min: 0, step: '0.01' },
        {
          name: 'prioridade',
          label: 'Prioridade',
          type: 'select',
          defaultValue: 'media',
          options: [
            { value: 'baixa', label: 'Baixa' },
            { value: 'media', label: 'M√©dia' },
            { value: 'alta', label: 'Alta' },
            { value: 'urgente', label: 'Urgente' }
          ]
        }
      ],
      onSubmit: async (data) => {
        try {
          Modal.loading('Criando negocia√ß√£o...');

          await API.post('/api/crm/negociacoes', data);

          Modal.closeLoading();
          Toast.success('Negocia√ß√£o criada com sucesso!');
          await this.loadDeals();
          await this.loadStats();
        } catch (error) {
          Modal.closeLoading();
          Toast.error(error.message || 'Erro ao criar negocia√ß√£o');
          return false;
        }
      }
    });
  },

  async openEditDealModal(dealId) {
    try {
      Modal.loading('Carregando negocia√ß√£o...');

      const response = await API.get(`/api/crm/negociacoes/${dealId}`);
      const deal = response.negociacao || response;

      Modal.closeLoading();

      Modal.form({
        id: 'modal-edit-deal',
        title: 'Editar Negocia√ß√£o',
        size: 'lg',
        data: deal,
        fields: [
          { name: 'titulo', label: 'T√≠tulo', type: 'text', required: true },
          { name: 'descricao', label: 'Descri√ß√£o', type: 'textarea' },
          { name: 'valor', label: 'Valor (R$)', type: 'number', min: 0, step: '0.01' },
          {
            name: 'prioridade',
            label: 'Prioridade',
            type: 'select',
            options: [
              { value: 'baixa', label: 'Baixa' },
              { value: 'media', label: 'M√©dia' },
              { value: 'alta', label: 'Alta' },
              { value: 'urgente', label: 'Urgente' }
            ]
          }
        ],
        onSubmit: async (data) => {
          try {
            Modal.loading('Atualizando negocia√ß√£o...');

            await API.put(`/api/crm/negociacoes/${dealId}`, data);

            Modal.closeLoading();
            Toast.success('Negocia√ß√£o atualizada com sucesso!');
            await this.loadDeals();
            await this.loadStats();
          } catch (error) {
            Modal.closeLoading();
            Toast.error(error.message || 'Erro ao atualizar negocia√ß√£o');
            return false;
          }
        }
      });
    } catch (error) {
      Modal.closeLoading();
      Toast.error('Erro ao carregar negocia√ß√£o');
    }
  },

  async viewDeal(dealId) {
    try {
      Modal.loading('Carregando detalhes...');

      const [dealResponse, historicoResponse] = await Promise.all([
        API.get(`/api/crm/negociacoes/${dealId}`),
        API.get(`/api/crm/negociacoes/${dealId}/historico`)
      ]);

      const deal = dealResponse.negociacao || dealResponse;
      const historico = historicoResponse.historico || [];

      Modal.closeLoading();

      const historicoHTML = historico.length > 0
        ? historico.slice(0, 5).map(h => `
            <div class="border-b pb-2 mb-2">
              <p class="text-sm font-semibold">${h.acao}</p>
              <p class="text-xs text-gray-500">${this.formatDate(h.data_hora)}</p>
            </div>
          `).join('')
        : '<p class="text-gray-500 text-sm">Nenhum hist√≥rico dispon√≠vel</p>';

      Modal.render({
        id: 'modal-view-deal',
        title: deal.titulo,
        size: 'lg',
        content: `
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-500 mb-1">Contato</label>
              <p>${deal.contato_nome || '-'}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-500 mb-1">Valor</label>
              <p class="text-lg font-bold text-green-600">${this.formatCurrency(deal.valor)}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-500 mb-1">Funil / Etapa</label>
              <p>${deal.funil_nome || '-'} / ${deal.etapa_nome || '-'}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-500 mb-1">Status</label>
              <span class="badge ${this.getStatusClass(deal.status)}">
                ${this.getStatusLabel(deal.status)}
              </span>
            </div>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-500 mb-1">Descri√ß√£o</label>
            <p>${deal.descricao || '-'}</p>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-500 mb-2">Hist√≥rico Recente</label>
            ${historicoHTML}
          </div>
        `,
        buttons: [
          { text: 'Fechar', class: 'btn btn-outline', onClick: () => Modal.close('modal-view-deal') }
        ]
      });

      Modal.open('modal-view-deal');
    } catch (error) {
      Modal.closeLoading();
      Toast.error('Erro ao carregar negocia√ß√£o');
    }
  },

  async winDeal(dealId) {
    Modal.confirm({
      title: 'Marcar como Ganha',
      message: 'Deseja marcar esta negocia√ß√£o como ganha?',
      confirmText: 'Sim, Ganhar',
      onConfirm: async () => {
        try {
          await API.post(`/api/crm/negociacoes/${dealId}/ganhar`);
          Toast.success('Negocia√ß√£o marcada como ganha! üéâ');
          await this.loadDeals();
          await this.loadStats();
        } catch (error) {
          Toast.error(error.message || 'Erro ao atualizar negocia√ß√£o');
        }
      }
    });
  },

  async loseDeal(dealId) {
    Modal.form({
      id: 'modal-lose-deal',
      title: 'Marcar como Perdida',
      size: 'sm',
      fields: [
        { name: 'motivo', label: 'Motivo da Perda', type: 'textarea', required: true, placeholder: 'Explique o motivo...' }
      ],
      submitText: 'Confirmar Perda',
      onSubmit: async (data) => {
        try {
          await API.post(`/api/crm/negociacoes/${dealId}/perder`, data);
          Toast.success('Negocia√ß√£o marcada como perdida');
          await this.loadDeals();
          await this.loadStats();
        } catch (error) {
          Toast.error(error.message || 'Erro ao atualizar negocia√ß√£o');
          return false;
        }
      }
    });
  },

  formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(value || 0);
  },

  formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  },

  getPriorityClass(priority) {
    const classes = {
      baixa: 'badge-secondary',
      media: 'badge-warning',
      alta: 'badge-error',
      urgente: 'badge-error'
    };
    return classes[priority] || 'badge-secondary';
  },

  getPriorityLabel(priority) {
    const labels = {
      baixa: 'Baixa',
      media: 'M√©dia',
      alta: 'Alta',
      urgente: 'Urgente'
    };
    return labels[priority] || priority;
  },

  getStatusClass(status) {
    const classes = {
      aberta: 'badge-warning',
      ganha: 'badge-success',
      perdida: 'badge-error'
    };
    return classes[status] || 'badge-secondary';
  },

  getStatusLabel(status) {
    const labels = {
      aberta: 'Aberta',
      ganha: 'Ganha',
      perdida: 'Perdida'
    };
    return labels[status] || status;
  }
};

// Inicializar
CRM.init();
</script>

</body>
</html>
