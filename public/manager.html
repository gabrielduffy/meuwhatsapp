<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsBenemax - Manager</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #075e54, #128c7e); min-height: 100vh; }
    .header { background: rgba(0,0,0,0.2); padding: 20px; text-align: center; color: white; }
    .header h1 { font-size: 1.8rem; margin-bottom: 5px; }
    .header p { opacity: 0.9; }
    .nav { display: flex; justify-content: center; gap: 10px; padding: 15px; background: rgba(0,0,0,0.1); flex-wrap: wrap; }
    .nav a { color: white; text-decoration: none; padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.1); transition: all 0.3s; }
    .nav a:hover, .nav a.active { background: rgba(255,255,255,0.3); }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .config-bar { background: white; border-radius: 10px; padding: 15px; margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .config-bar input { flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    .config-bar button { padding: 10px 20px; background: #25d366; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .card h2 { color: #075e54; margin-bottom: 15px; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
    .btn-primary { background: #25d366; color: white; }
    .btn-primary:hover { background: #128c7e; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-sm { padding: 5px 10px; font-size: 0.9rem; }
    .instance-grid { display: grid; gap: 15px; }
    .instance-card { background: #f8f9fa; border-radius: 8px; padding: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .instance-info { display: flex; align-items: center; gap: 15px; }
    .instance-name { font-weight: 600; font-size: 1.1rem; }
    .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
    .status-connected { background: #d4edda; color: #155724; }
    .status-disconnected { background: #f8d7da; color: #721c24; }
    .instance-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .qr-section { text-align: center; padding: 20px; }
    .qr-section img { max-width: 250px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab { padding: 10px 20px; background: #e9ecef; border: none; border-radius: 5px 5px 0 0; cursor: pointer; font-weight: 500; }
    .tab.active { background: white; color: #075e54; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .alert { padding: 12px 20px; border-radius: 5px; margin-bottom: 15px; }
    .alert-success { background: #d4edda; color: #155724; }
    .alert-error { background: #f8d7da; color: #721c24; }
    .alert-info { background: #d1ecf1; color: #0c5460; }
    #alerts { position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 350px; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #25d366; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .response-box { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow: auto; white-space: pre-wrap; word-break: break-all; }
    .hidden { display: none; }
    .warming-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
    .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: 600; color: #075e54; }
    .stat-label { font-size: 0.85rem; color: #666; }
    select { background: white; }
    .section-title { font-size: 1rem; color: #666; margin: 20px 0 10px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <div id="alerts"></div>
  
  <div class="header">
    <h1>ğŸ“± WhatsBenemax</h1>
    <p>Painel de Gerenciamento v2.1</p>
  </div>
  
  <div class="nav">
    <a href="#" class="active" onclick="showSection('instances')">ğŸ“‹ InstÃ¢ncias</a>
    <a href="#" onclick="showSection('messages')">ğŸ’¬ Mensagens</a>
    <a href="#" onclick="showSection('groups')">ğŸ‘¥ Grupos</a>
    <a href="#" onclick="showSection('contacts')">ğŸ“‡ Contatos</a>
    <a href="#" onclick="showSection('autoresponder')">ğŸ¤– Auto-Resposta</a>
    <a href="#" onclick="showSection('broadcast')">ğŸ“¢ Broadcast</a>
    <a href="#" onclick="showSection('scheduler')">â° Agendamento</a>
    <a href="#" onclick="showSection('warming')">ğŸ”¥ Aquecimento</a>
    <a href="#" onclick="showSection('tools')">ğŸ”§ Ferramentas</a>
    <a href="/dashboard" target="_blank">ğŸ“Š Dashboard</a>
    <a href="/docs" target="_blank">ğŸ“– Docs</a>
  </div>
  
  <div class="container">
    <div class="config-bar">
      <input type="text" id="apiUrl" placeholder="URL da API">
      <input type="text" id="apiKey" placeholder="API Key">
      <button onclick="saveConfig()">ğŸ’¾ Salvar</button>
      <button onclick="testConnection()" class="btn-secondary">ğŸ”Œ Testar</button>
    </div>
    
    <!-- INSTÃ‚NCIAS -->
    <div id="instances" class="section">
      <div class="card">
        <h2>â• Nova InstÃ¢ncia</h2>
        <div class="form-row">
          <div class="form-group">
            <label>Nome da InstÃ¢ncia</label>
            <input type="text" id="newInstanceName" placeholder="ex: whats1">
          </div>
          <div class="form-group">
            <label>Proxy (opcional)</label>
            <input type="text" id="newInstanceProxy" placeholder="host:port:user:pass">
          </div>
        </div>
        <button class="btn btn-primary" onclick="createInstance()">Criar InstÃ¢ncia</button>
      </div>
      
      <div class="card">
        <h2>ğŸ“± InstÃ¢ncias Ativas</h2>
        <button class="btn btn-secondary btn-sm" onclick="loadInstances()" style="margin-bottom:15px">ğŸ”„ Atualizar</button>
        <div id="instanceList" class="instance-grid">
          <p style="color:#666">Clique em Atualizar para carregar</p>
        </div>
      </div>
      
      <div id="qrSection" class="card hidden">
        <h2>ğŸ“· QR Code - <span id="qrInstanceName"></span></h2>
        <div class="qr-section">
          <div id="qrLoader" class="loader hidden"></div>
          <img id="qrImage" src="" class="hidden">
          <p id="qrStatus" style="margin-top:15px"></p>
          <div style="margin-top:15px">
            <button class="btn btn-primary" onclick="refreshQR()">ğŸ”„ Atualizar QR</button>
            <button class="btn btn-secondary" onclick="getPairingCode()">ğŸ“± CÃ³digo de Pareamento</button>
          </div>
          <p id="pairingCodeDisplay" class="hidden" style="margin-top:15px;font-size:1.5rem;font-weight:bold;letter-spacing:5px"></p>
        </div>
      </div>
    </div>
    
    <!-- MENSAGENS -->
    <div id="messages" class="section hidden">
      <div class="tabs">
        <button class="tab active" onclick="showMsgTab('text')">Texto</button>
        <button class="tab" onclick="showMsgTab('image')">Imagem</button>
        <button class="tab" onclick="showMsgTab('document')">Documento</button>
        <button class="tab" onclick="showMsgTab('audio')">Ãudio</button>
        <button class="tab" onclick="showMsgTab('poll')">Enquete</button>
      </div>
      
      <div id="msgText" class="tab-content active">
        <div class="card">
          <h2>ğŸ’¬ Enviar Texto</h2>
          <div class="form-group">
            <label>InstÃ¢ncia</label>
            <select id="textInstance"></select>
          </div>
          <div class="form-group">
            <label>NÃºmero</label>
            <input type="text" id="textTo" placeholder="5511999999999">
          </div>
          <div class="form-group">
            <label>Mensagem</label>
            <textarea id="textMsg" placeholder="Digite sua mensagem..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label><input type="checkbox" id="textTyping"> Simular digitaÃ§Ã£o</label>
            </div>
            <div class="form-group">
              <label>Delay (ms)</label>
              <input type="number" id="textDelay" placeholder="0">
            </div>
          </div>
          <button class="btn btn-primary" onclick="sendTextMsg()">ğŸ“¤ Enviar</button>
        </div>
      </div>
      
      <div id="msgImage" class="tab-content">
        <div class="card">
          <h2>ğŸ–¼ï¸ Enviar Imagem</h2>
          <div class="form-group">
            <label>InstÃ¢ncia</label>
            <select id="imageInstance"></select>
          </div>
          <div class="form-group">
            <label>NÃºmero</label>
            <input type="text" id="imageTo" placeholder="5511999999999">
          </div>
          <div class="form-group">
            <label>URL da Imagem</label>
            <input type="text" id="imageUrl" placeholder="https://...">
          </div>
          <div class="form-group">
            <label>Legenda (opcional)</label>
            <input type="text" id="imageCaption">
          </div>
          <button class="btn btn-primary" onclick="sendImageMsg()">ğŸ“¤ Enviar</button>
        </div>
      </div>
      
      <div id="msgDocument" class="tab-content">
        <div class="card">
          <h2>ğŸ“„ Enviar Documento</h2>
          <div class="form-group">
            <label>InstÃ¢ncia</label>
            <select id="docInstance"></select>
          </div>
          <div class="form-group">
            <label>NÃºmero</label>
            <input type="text" id="docTo" placeholder="5511999999999">
          </div>
          <div class="form-group">
            <label>URL do Documento</label>
            <input type="text" id="docUrl" placeholder="https://...">
          </div>
          <div class="form-group">
            <label>Nome do Arquivo</label>
            <input type="text" id="docName" placeholder="documento.pdf">
          </div>
          <button class="btn btn-primary" onclick="sendDocMsg()">ğŸ“¤ Enviar</button>
        </div>
      </div>
      
      <div id="msgAudio" class="tab-content">
        <div class="card">
          <h2>ğŸµ Enviar Ãudio</h2>
          <div class="form-group">
            <label>InstÃ¢ncia</label>
            <select id="audioInstance"></select>
          </div>
          <div class="form-group">
            <label>NÃºmero</label>
            <input type="text" id="audioTo" placeholder="5511999999999">
          </div>
          <div class="form-group">
            <label>URL do Ãudio</label>
            <input type="text" id="audioUrl" placeholder="https://...">
          </div>
          <div class="form-group">
            <label><input type="checkbox" id="audioPtt" checked> Enviar como mensagem de voz</label>
          </div>
          <button class="btn btn-primary" onclick="sendAudioMsg()">ğŸ“¤ Enviar</button>
        </div>
      </div>
      
      <div id="msgPoll" class="tab-content">
        <div class="card">
          <h2>ğŸ“Š Enviar Enquete</h2>
          <div class="form-group">
            <label>InstÃ¢ncia</label>
            <select id="pollInstance"></select>
          </div>
          <div class="form-group">
            <label>NÃºmero</label>
            <input type="text" id="pollTo" placeholder="5511999999999">
          </div>
          <div class="form-group">
            <label>Pergunta</label>
            <input type="text" id="pollName" placeholder="Qual sua cor favorita?">
          </div>
          <div class="form-group">
            <label>OpÃ§Ãµes (uma por linha)</label>
            <textarea id="pollValues" placeholder="Azul&#10;Vermelho&#10;Verde"></textarea>
          </div>
          <button class="btn btn-primary" onclick="sendPollMsg()">ğŸ“¤ Enviar</button>
        </div>
      </div>
    </div>
    
    <!-- GRUPOS -->
    <div id="groups" class="section hidden">
      <div class="card">
        <h2>ğŸ‘¥ Criar Grupo</h2>
        <div class="form-group">
          <label>InstÃ¢ncia</label>
          <select id="groupInstance"></select>
        </div>
        <div class="form-group">
          <label>Nome do Grupo</label>
          <input type="text" id="groupName" placeholder="Meu Grupo">
        </div>
        <div class="form-group">
          <label>Participantes (separados por vÃ­rgula)</label>
          <input type="text" id="groupParticipants" placeholder="5511999999999, 5511888888888">
        </div>
        <button class="btn btn-primary" onclick="createGroup()">â• Criar</button>
      </div>
      
      <div class="card">
        <h2>ğŸ“‹ Listar Grupos</h2>
        <div class="form-row">
          <div class="form-group">
            <label>InstÃ¢ncia</label>
            <select id="listGroupInstance"></select>
          </div>
        </div>
        <button class="btn btn-secondary" onclick="listGroups()">ğŸ”„ Carregar Grupos</button>
        <div id="groupList" style="margin-top:15px"></div>
      </div>
      
      <div class="card">
        <h2>ğŸ”— Entrar em Grupo</h2>
        <div class="form-group">
          <label>InstÃ¢ncia</label>
          <select id="joinGroupInstance"></select>
        </div>
        <div class="form-group">
          <label>Link do Grupo</label>
          <input type="text" id="joinGroupLink" placeholder="https://chat.whatsapp.com/xxx">
        </div>
        <button class="btn btn-primary" onclick="joinGroup()">ğŸš€ Entrar</button>
      </div>
    </div>

    <!-- CONTATOS -->
    <div id="contacts" class="section hidden">
      <div class="card">
        <h2>ğŸ“‡ Gerenciar Contatos</h2>
        <div class="form-group">
          <label>InstÃ¢ncia</label>
          <select id="contactsInstance" onchange="loadContacts()"></select>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="loadContacts()">ğŸ”„ Atualizar Lista</button>
        <div id="contactsList" style="margin-top:15px">
          <p style="color:#666">Selecione uma instÃ¢ncia</p>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“¤ Importar/Exportar</h2>
        <div class="form-row">
          <div class="form-group">
            <label>InstÃ¢ncia</label>
            <select id="importExportInstance"></select>
          </div>
          <div class="form-group">
            <label>Formato de ExportaÃ§Ã£o</label>
            <select id="exportFormat">
              <option value="csv">CSV</option>
              <option value="excel">Excel</option>
              <option value="json">JSON</option>
            </select>
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="exportContacts()">ğŸ“¥ Exportar</button>
          <button class="btn btn-secondary" onclick="syncContacts()">ğŸ”„ Sincronizar com WhatsApp</button>
        </div>
      </div>
    </div>

    <!-- AUTO-RESPOSTA -->
    <div id="autoresponder" class="section hidden">
      <div class="card">
        <h2>ğŸ¤– Configurar Auto-Resposta IA</h2>
        <div class="form-group">
          <label>InstÃ¢ncia</label>
          <select id="autoresponderInstance"></select>
        </div>
        <div class="form-group">
          <label>Chave API Groq</label>
          <input type="text" id="autoresponderGroqKey" placeholder="gsk_...">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Modelo</label>
            <select id="autoresponderModel">
              <option value="llama-3.1-8b-instant">Llama 3.1 8B (RÃ¡pido)</option>
              <option value="llama-3.1-70b-versatile">Llama 3.1 70B (Preciso)</option>
              <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
            </select>
          </div>
          <div class="form-group">
            <label>Responder a</label>
            <select id="autoresponderRespondTo">
              <option value="all">Todos</option>
              <option value="contacts">Apenas Contatos</option>
              <option value="groups">Apenas Grupos</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Personalidade</label>
          <input type="text" id="autoresponderPersonality" placeholder="Atendente prestativo e amigÃ¡vel" value="Atendente prestativo e amigÃ¡vel">
        </div>
        <div class="form-group">
          <label>Contexto do NegÃ³cio</label>
          <textarea id="autoresponderContext" placeholder="Descreva seu negÃ³cio, produtos/serviÃ§os, horÃ¡rios...">Sou um assistente virtual</textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Tamanho MÃ¡x Resposta</label>
            <input type="number" id="autoresponderMaxLength" value="500">
          </div>
          <div class="form-group">
            <label>MÃ¡x Respostas/Contato/Dia</label>
            <input type="number" id="autoresponderMaxResponses" value="5">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Hora InÃ­cio</label>
            <input type="number" id="autoresponderStartHour" value="0" min="0" max="23">
          </div>
          <div class="form-group">
            <label>Hora Fim</label>
            <input type="number" id="autoresponderEndHour" value="23" min="0" max="23">
          </div>
          <div class="form-group">
            <label><input type="checkbox" id="autoresponderWeekend" checked> Ativo nos fins de semana</label>
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <button class="btn btn-primary" onclick="configureAutoResponder()">ğŸ’¾ Configurar</button>
          <button class="btn btn-secondary" onclick="enableAutoResponder()">â–¶ï¸ Ativar</button>
          <button class="btn btn-danger" onclick="disableAutoResponder()">â¹ï¸ Desativar</button>
          <button class="btn btn-secondary" onclick="loadAutoResponderStats()">ğŸ“Š EstatÃ­sticas</button>
        </div>
        <div id="autoresponderStats" style="margin-top:15px"></div>
      </div>
    </div>

    <!-- BROADCAST -->
    <div id="broadcast" class="section hidden">
      <div class="card">
        <h2>ğŸ“¢ Criar Campanha de Broadcast</h2>
        <div class="form-row">
          <div class="form-group">
            <label>InstÃ¢ncia</label>
            <select id="broadcastInstance"></select>
          </div>
          <div class="form-group">
            <label>Nome da Campanha</label>
            <input type="text" id="broadcastName" placeholder="Minha Campanha">
          </div>
        </div>
        <div class="form-group">
          <label>NÃºmeros Destino (um por linha)</label>
          <textarea id="broadcastNumbers" placeholder="5511999999999&#10;5511888888888"></textarea>
        </div>
        <div class="form-group">
          <label>Mensagem</label>
          <textarea id="broadcastMessage" placeholder="OlÃ¡! Esta Ã© uma mensagem de teste."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Intervalo MÃ­n (segundos)</label>
            <input type="number" id="broadcastMinDelay" value="30">
          </div>
          <div class="form-group">
            <label>Intervalo MÃ¡x (segundos)</label>
            <input type="number" id="broadcastMaxDelay" value="60">
          </div>
          <div class="form-group">
            <label>MÃ¡x Mensagens/Hora</label>
            <input type="number" id="broadcastMaxPerHour" value="20">
          </div>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="broadcastSimulateTyping" checked> Simular digitaÃ§Ã£o</label>
        </div>
        <button class="btn btn-primary" onclick="createBroadcast()">ğŸš€ Criar Campanha</button>
      </div>

      <div class="card">
        <h2>ğŸ“‹ Campanhas Ativas</h2>
        <div class="form-group">
          <label>Filtrar por InstÃ¢ncia</label>
          <select id="broadcastFilterInstance" onchange="loadBroadcasts()"></select>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="loadBroadcasts()">ğŸ”„ Atualizar</button>
        <div id="broadcastList" style="margin-top:15px">
          <p style="color:#666">Selecione uma instÃ¢ncia</p>
        </div>
      </div>
    </div>

    <!-- AQUECIMENTO -->
    <div id="warming" class="section hidden">
      <div class="card">
        <h2>ğŸ”¥ Configurar Aquecimento</h2>
        <div class="form-row">
          <div class="form-group">
            <label>InstÃ¢ncia Principal</label>
            <select id="warmingInstance"></select>
          </div>
          <div class="form-group">
            <label>InstÃ¢ncia Parceira (conversar com)</label>
            <select id="warmingPartner">
              <option value="">-- Nenhuma --</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Chave API Groq</label>
          <input type="text" id="warmingGroqKey" placeholder="gsk_...">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Mensagens por Dia</label>
            <input type="number" id="warmingMsgsDay" value="20">
          </div>
          <div class="form-group">
            <label>Intervalo MÃ­n (min)</label>
            <input type="number" id="warmingMinInterval" value="30">
          </div>
          <div class="form-group">
            <label>Intervalo MÃ¡x (min)</label>
            <input type="number" id="warmingMaxInterval" value="120">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Hora InÃ­cio</label>
            <input type="number" id="warmingStartHour" value="8" min="0" max="23">
          </div>
          <div class="form-group">
            <label>Hora Fim</label>
            <input type="number" id="warmingEndHour" value="22" min="0" max="23">
          </div>
          <div class="form-group">
            <label>Personalidade</label>
            <select id="warmingPersonality">
              <option value="casual">Casual</option>
              <option value="profissional">Profissional</option>
              <option value="animado">Animado</option>
              <option value="tranquilo">Tranquilo</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>TÃ³picos (separados por vÃ­rgula)</label>
          <input type="text" id="warmingTopics" value="trabalho, tecnologia, futebol, sÃ©ries, mÃºsica">
        </div>
        <div class="form-group">
          <label>Links de Grupos para Entrar (opcional, um por linha)</label>
          <textarea id="warmingGroups" placeholder="https://chat.whatsapp.com/xxx"></textarea>
        </div>
        <button class="btn btn-primary" onclick="startWarming()">â–¶ï¸ Iniciar Aquecimento</button>
        <button class="btn btn-danger" onclick="stopWarming()">â¹ï¸ Parar</button>
      </div>
      
      <div class="card">
        <h2>ğŸ“Š Status do Aquecimento</h2>
        <button class="btn btn-secondary btn-sm" onclick="loadWarmingStatus()" style="margin-bottom:15px">ğŸ”„ Atualizar</button>
        <div id="warmingStatus">
          <p style="color:#666">Clique em Atualizar para ver o status</p>
        </div>
      </div>
    </div>

    <!-- AGENDAMENTO -->
    <div id="scheduler" class="section hidden">
      <div class="card">
        <h2>â° Agendar Nova Mensagem</h2>
        <div class="form-row">
          <div class="form-group">
            <label>InstÃ¢ncia</label>
            <select id="scheduleInstance"></select>
          </div>
          <div class="form-group">
            <label>NÃºmero de Destino</label>
            <input type="text" id="scheduleTo" placeholder="5511999999999@s.whatsapp.net">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Data e Hora</label>
            <input type="datetime-local" id="scheduleDateTime">
          </div>
          <div class="form-group">
            <label>Tipo de Mensagem</label>
            <select id="scheduleType" onchange="updateScheduleFields()">
              <option value="text">Texto</option>
              <option value="image">Imagem</option>
              <option value="document">Documento</option>
              <option value="audio">Ãudio</option>
              <option value="video">VÃ­deo</option>
            </select>
          </div>
        </div>

        <!-- Campos dinÃ¢micos baseados no tipo -->
        <div id="scheduleFields">
          <div class="form-group">
            <label>Mensagem</label>
            <textarea id="scheduleText" placeholder="Digite a mensagem a ser enviada"></textarea>
          </div>
        </div>

        <button class="btn btn-primary" onclick="createSchedule()">ğŸ“… Agendar</button>
      </div>

      <div class="card">
        <h2>ğŸ“‹ Mensagens Agendadas</h2>
        <div class="form-row">
          <div class="form-group">
            <label>Filtrar por InstÃ¢ncia</label>
            <select id="scheduleFilterInstance" onchange="loadScheduledMessages()">
              <option value="">Todas</option>
            </select>
          </div>
          <div class="form-group">
            <label>Filtrar por Status</label>
            <select id="scheduleFilterStatus" onchange="loadScheduledMessages()">
              <option value="">Todos</option>
              <option value="pending">Pendente</option>
              <option value="sent">Enviado</option>
              <option value="failed">Falhado</option>
              <option value="cancelled">Cancelado</option>
            </select>
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="loadScheduledMessages()" style="margin-bottom:15px">ğŸ”„ Atualizar</button>
        <div id="scheduledMessages">
          <p style="color:#666">Carregando...</p>
        </div>
      </div>
    </div>

    <!-- FERRAMENTAS -->
    <div id="tools" class="section hidden">
      <div class="card">
        <h2>ğŸ” Verificar NÃºmero</h2>
        <div class="form-row">
          <div class="form-group">
            <label>InstÃ¢ncia</label>
            <select id="checkInstance"></select>
          </div>
          <div class="form-group">
            <label>NÃºmero</label>
            <input type="text" id="checkNumber" placeholder="5511999999999">
          </div>
        </div>
        <button class="btn btn-primary" onclick="checkNumber()">Verificar</button>
        <div id="checkResult" style="margin-top:15px"></div>
      </div>
      
      <div class="card">
        <h2>âš™ï¸ Webhook AvanÃ§ado</h2>
        <div class="form-group">
          <label>InstÃ¢ncia</label>
          <select id="webhookInstance" onchange="loadWebhookConfig()"></select>
        </div>
        <div class="form-group">
          <label>URL do Webhook</label>
          <input type="text" id="webhookUrl" placeholder="https://seu-servidor.com/webhook">
        </div>

        <div class="section-title">ConfiguraÃ§Ãµes de Retry</div>
        <div class="form-row">
          <div class="form-group">
            <label>MÃ¡ximo de Tentativas</label>
            <input type="number" id="webhookMaxRetries" value="3" min="1" max="10">
          </div>
          <div class="form-group">
            <label>Delay Inicial (ms)</label>
            <input type="number" id="webhookRetryDelay" value="5000" step="1000">
          </div>
          <div class="form-group">
            <label>Timeout (ms)</label>
            <input type="number" id="webhookTimeout" value="30000" step="1000">
          </div>
        </div>

        <div class="section-title">Tipos de Eventos</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:15px">
          <label><input type="checkbox" id="webhookEventMessage" value="message" checked> Mensagens</label>
          <label><input type="checkbox" id="webhookEventUpdate" value="message.update" checked> AtualizaÃ§Ãµes</label>
          <label><input type="checkbox" id="webhookEventReceipt" value="message.receipt" checked> Recibos</label>
          <label><input type="checkbox" id="webhookEventConnection" value="connection.update" checked> ConexÃ£o</label>
          <label><input type="checkbox" id="webhookEventQr" value="qr" checked> QR Code</label>
          <label><input type="checkbox" id="webhookEventGroup" value="group-participants.update" checked> Grupos</label>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="configureAdvancedWebhook()">ğŸ’¾ Configurar</button>
          <button class="btn btn-secondary" onclick="testWebhook()">ğŸ§ª Testar</button>
          <button class="btn btn-secondary" onclick="loadWebhookLogs()">ğŸ“œ Ver Logs</button>
          <button class="btn btn-secondary" onclick="loadWebhookStats()">ğŸ“Š EstatÃ­sticas</button>
        </div>

        <div id="webhookInfo" style="margin-top:15px"></div>
      </div>

      <div class="card" id="webhookLogsCard" style="display:none">
        <h2>ğŸ“œ Logs de Webhook</h2>
        <div class="form-row">
          <div class="form-group">
            <label>Filtrar por Status</label>
            <select id="webhookLogStatus" onchange="loadWebhookLogs()">
              <option value="">Todos</option>
              <option value="success">Sucesso</option>
              <option value="error">Erro</option>
              <option value="failed">Falhado</option>
            </select>
          </div>
          <div class="form-group">
            <label>Limite</label>
            <input type="number" id="webhookLogLimit" value="50" min="10" max="200" onchange="loadWebhookLogs()">
          </div>
        </div>
        <button class="btn btn-danger btn-sm" onclick="clearWebhookLogs()">ğŸ—‘ï¸ Limpar Logs</button>
        <div id="webhookLogsList" style="margin-top:15px"></div>
      </div>

      <div class="card" id="webhookStatsCard" style="display:none">
        <h2>ğŸ“Š EstatÃ­sticas de Webhook</h2>
        <div class="form-group">
          <label>PerÃ­odo</label>
          <select id="webhookStatsPeriod" onchange="loadWebhookStats()">
            <option value="hour">Ãšltima Hora</option>
            <option value="day" selected>Ãšltimo Dia</option>
            <option value="week">Ãšltima Semana</option>
          </select>
        </div>
        <div id="webhookStatsDisplay"></div>
      </div>
      
      <div class="card">
        <h2>ğŸ“‹ Ãšltima Resposta</h2>
        <div id="lastResponse" class="response-box">Nenhuma requisiÃ§Ã£o feita</div>
      </div>
    </div>
  </div>
  
  <script>
    let currentQRInstance = '';
    const API_URL = () => document.getElementById('apiUrl').value.replace(/\/$/, '');
    const API_KEY = () => document.getElementById('apiKey').value;
    
    // Carregar config salva
    document.getElementById('apiUrl').value = localStorage.getItem('waApiUrl') || location.origin;
    document.getElementById('apiKey').value = localStorage.getItem('waApiKey') || '';
    
    function saveConfig() {
      localStorage.setItem('waApiUrl', API_URL());
      localStorage.setItem('waApiKey', API_KEY());
      showAlert('ConfiguraÃ§Ã£o salva!', 'success');
    }
    
    async function testConnection() {
      try {
        const res = await fetch(API_URL() + '/health');
        const data = await res.json();
        showAlert('Conectado! v' + (data.version || '?'), 'success');
      } catch(e) {
        showAlert('Erro ao conectar: ' + e.message, 'error');
      }
    }
    
    function showAlert(msg, type) {
      const div = document.createElement('div');
      div.className = 'alert alert-' + type;
      div.textContent = msg;
      document.getElementById('alerts').appendChild(div);
      setTimeout(() => div.remove(), 4000);
    }
    
    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
      event.target.classList.add('active');
    }
    
    function showMsgTab(tab) {
      document.querySelectorAll('#messages .tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('#messages .tab').forEach(t => t.classList.remove('active'));
      document.getElementById('msg' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
      event.target.classList.add('active');
    }
    
    async function api(endpoint, method = 'GET', body = null) {
      const opts = {
        method,
        headers: { 'X-API-Key': API_KEY(), 'Content-Type': 'application/json' }
      };
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch(API_URL() + endpoint, opts);
      const data = await res.json();
      document.getElementById('lastResponse').textContent = JSON.stringify(data, null, 2);
      return data;
    }
    
    async function loadInstances() {
      try {
        const data = await api('/instance/list');
        const list = document.getElementById('instanceList');
        const instances = Object.entries(data);
        
        if (!instances.length) {
          list.innerHTML = '<p style="color:#666">Nenhuma instÃ¢ncia</p>';
          updateSelects([]);
          return;
        }
        
        list.innerHTML = instances.map(([name, info]) => `
          <div class="instance-card">
            <div class="instance-info">
              <span class="instance-name">${name}</span>
              <span class="status-badge ${info.isConnected ? 'status-connected' : 'status-disconnected'}">
                ${info.isConnected ? 'ğŸŸ¢ Conectado' : 'ğŸ”´ Desconectado'}
              </span>
              ${info.proxy ? '<span style="font-size:0.8rem;color:#666">ğŸŒ ' + info.proxy + '</span>' : ''}
            </div>
            <div class="instance-actions">
              ${!info.isConnected ? '<button class="btn btn-primary btn-sm" onclick="showQR(\'' + name + '\')">ğŸ“· QR</button>' : ''}
              <button class="btn btn-secondary btn-sm" onclick="restartInstance('${name}')">ğŸ”„</button>
              <button class="btn btn-danger btn-sm" onclick="deleteInstance('${name}')">ğŸ—‘ï¸</button>
            </div>
          </div>
        `).join('');
        
        updateSelects(instances.map(([n]) => n));
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    function updateSelects(instances) {
      const ids = ['textInstance','imageInstance','docInstance','audioInstance','pollInstance','groupInstance','listGroupInstance','joinGroupInstance','warmingInstance','warmingPartner','checkInstance','webhookInstance','scheduleInstance','scheduleFilterInstance','contactsInstance','importExportInstance','autoresponderInstance','broadcastInstance','broadcastFilterInstance'];
      ids.forEach(id => {
        const sel = document.getElementById(id);
        const val = sel.value;
        sel.innerHTML = '<option value="">Selecione...</option>' + instances.map(n => '<option value="'+n+'">'+n+'</option>').join('');
        sel.value = val;
      });
    }
    
    async function createInstance() {
      const name = document.getElementById('newInstanceName').value.trim();
      if (!name) return showAlert('Digite o nome', 'error');
      
      const proxyStr = document.getElementById('newInstanceProxy').value.trim();
      let proxy = null;
      if (proxyStr) {
        const parts = proxyStr.split(':');
        proxy = { host: parts[0], port: parts[1], username: parts[2], password: parts[3] };
      }
      
      try {
        await api('/instance/create', 'POST', { instanceName: name, proxy });
        showAlert('InstÃ¢ncia criada!', 'success');
        document.getElementById('newInstanceName').value = '';
        loadInstances();
        setTimeout(() => showQR(name), 1000);
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    async function deleteInstance(name) {
      if (!confirm('Deletar ' + name + '?')) return;
      try {
        await api('/instance/' + name, 'DELETE');
        showAlert('Deletada!', 'success');
        loadInstances();
        document.getElementById('qrSection').classList.add('hidden');
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    async function restartInstance(name) {
      try {
        await api('/instance/' + name + '/restart', 'POST');
        showAlert('Reiniciando...', 'info');
        setTimeout(loadInstances, 3000);
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    function showQR(name) {
      currentQRInstance = name;
      document.getElementById('qrSection').classList.remove('hidden');
      document.getElementById('qrInstanceName').textContent = name;
      document.getElementById('pairingCodeDisplay').classList.add('hidden');
      refreshQR();
    }
    
    async function refreshQR() {
      if (!currentQRInstance) return;
      const loader = document.getElementById('qrLoader');
      const img = document.getElementById('qrImage');
      const status = document.getElementById('qrStatus');
      
      loader.classList.remove('hidden');
      img.classList.add('hidden');
      status.textContent = 'Carregando...';
      
      try {
        const data = await api('/instance/' + currentQRInstance + '/qrcode');
        loader.classList.add('hidden');
        
        if (data.status === 'connected') {
          status.textContent = 'âœ… Conectado!';
          status.style.color = '#155724';
          loadInstances();
        } else if (data.qrcodeBase64) {
          img.src = data.qrcodeBase64;
          img.classList.remove('hidden');
          status.textContent = 'ğŸ“± Escaneie o QR Code';
          status.style.color = '#856404';
        } else {
          status.textContent = 'â³ Aguardando QR Code...';
          status.style.color = '#0c5460';
        }
      } catch(e) {
        loader.classList.add('hidden');
        status.textContent = 'âŒ Erro';
      }
    }
    
    async function getPairingCode() {
      const phone = prompt('Digite seu nÃºmero com DDI (ex: 5511999999999):');
      if (!phone) return;
      
      try {
        const data = await api('/instance/' + currentQRInstance + '/pairing-code', 'POST', { phoneNumber: phone });
        if (data.pairingCode) {
          const display = document.getElementById('pairingCodeDisplay');
          display.textContent = data.pairingCode;
          display.classList.remove('hidden');
          showAlert('CÃ³digo gerado! Digite no WhatsApp', 'success');
        }
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    async function sendTextMsg() {
      const inst = document.getElementById('textInstance').value;
      const to = document.getElementById('textTo').value;
      const text = document.getElementById('textMsg').value;
      if (!inst || !to || !text) return showAlert('Preencha todos os campos', 'error');
      
      const options = {};
      if (document.getElementById('textTyping').checked) options.simulateTyping = true;
      const delay = parseInt(document.getElementById('textDelay').value);
      if (delay > 0) options.delay = delay;
      
      try {
        await api('/message/send-text', 'POST', { instanceName: inst, to, text, options });
        showAlert('Enviada!', 'success');
        document.getElementById('textMsg').value = '';
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    async function sendImageMsg() {
      const inst = document.getElementById('imageInstance').value;
      const to = document.getElementById('imageTo').value;
      const imageUrl = document.getElementById('imageUrl').value;
      const caption = document.getElementById('imageCaption').value;
      if (!inst || !to || !imageUrl) return showAlert('Preencha os campos obrigatÃ³rios', 'error');
      
      try {
        await api('/message/send-image', 'POST', { instanceName: inst, to, imageUrl, caption });
        showAlert('Enviada!', 'success');
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    async function sendDocMsg() {
      const inst = document.getElementById('docInstance').value;
      const to = document.getElementById('docTo').value;
      const documentUrl = document.getElementById('docUrl').value;
      const fileName = document.getElementById('docName').value;
      if (!inst || !to || !documentUrl) return showAlert('Preencha os campos obrigatÃ³rios', 'error');
      
      try {
        await api('/message/send-document', 'POST', { instanceName: inst, to, documentUrl, fileName });
        showAlert('Enviado!', 'success');
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    async function sendAudioMsg() {
      const inst = document.getElementById('audioInstance').value;
      const to = document.getElementById('audioTo').value;
      const audioUrl = document.getElementById('audioUrl').value;
      const ptt = document.getElementById('audioPtt').checked;
      if (!inst || !to || !audioUrl) return showAlert('Preencha os campos obrigatÃ³rios', 'error');
      
      try {
        await api('/message/send-audio', 'POST', { instanceName: inst, to, audioUrl, ptt });
        showAlert('Enviado!', 'success');
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    async function sendPollMsg() {
      const inst = document.getElementById('pollInstance').value;
      const to = document.getElementById('pollTo').value;
      const name = document.getElementById('pollName').value;
      const values = document.getElementById('pollValues').value.split('\n').filter(v => v.trim());
      if (!inst || !to || !name || values.length < 2) return showAlert('Preencha todos os campos (mÃ­n 2 opÃ§Ãµes)', 'error');
      
      try {
        await api('/message/send-poll', 'POST', { instanceName: inst, to, name, values });
        showAlert('Enviada!', 'success');
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    async function createGroup() {
      const inst = document.getElementById('groupInstance').value;
      const groupName = document.getElementById('groupName').value;
      const participants = document.getElementById('groupParticipants').value.split(',').map(p => p.trim()).filter(p => p);
      if (!inst || !groupName || !participants.length) return showAlert('Preencha todos os campos', 'error');
      
      try {
        await api('/group/create', 'POST', { instanceName: inst, groupName, participants });
        showAlert('Grupo criado!', 'success');
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    async function listGroups() {
      const inst = document.getElementById('listGroupInstance').value;
      if (!inst) return showAlert('Selecione uma instÃ¢ncia', 'error');
      
      try {
        const data = await api('/group/list/' + inst);
        const list = document.getElementById('groupList');
        if (!data.groups?.length) {
          list.innerHTML = '<p style="color:#666">Nenhum grupo</p>';
          return;
        }
        list.innerHTML = data.groups.map(g => `
          <div style="padding:10px;background:#f8f9fa;border-radius:5px;margin-bottom:10px">
            <strong>${g.name}</strong><br>
            <small style="color:#666">${g.id} | ${g.participantsCount} participantes</small>
          </div>
        `).join('');
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    async function joinGroup() {
      const inst = document.getElementById('joinGroupInstance').value;
      const link = document.getElementById('joinGroupLink').value;
      if (!inst || !link) return showAlert('Preencha todos os campos', 'error');
      
      try {
        await api('/group/join', 'POST', { instanceName: inst, inviteCode: link });
        showAlert('Entrou no grupo!', 'success');
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    async function startWarming() {
      const inst = document.getElementById('warmingInstance').value;
      const groqApiKey = document.getElementById('warmingGroqKey').value;
      if (!inst || !groqApiKey) return showAlert('InstÃ¢ncia e chave Groq sÃ£o obrigatÃ³rias', 'error');
      
      const config = {
        instanceName: inst,
        groqApiKey,
        partnerInstance: document.getElementById('warmingPartner').value || null,
        messagesPerDay: parseInt(document.getElementById('warmingMsgsDay').value) || 20,
        minIntervalMinutes: parseInt(document.getElementById('warmingMinInterval').value) || 30,
        maxIntervalMinutes: parseInt(document.getElementById('warmingMaxInterval').value) || 120,
        activeHoursStart: parseInt(document.getElementById('warmingStartHour').value) || 8,
        activeHoursEnd: parseInt(document.getElementById('warmingEndHour').value) || 22,
        personality: document.getElementById('warmingPersonality').value,
        topics: document.getElementById('warmingTopics').value.split(',').map(t => t.trim()).filter(t => t),
        groupLinks: document.getElementById('warmingGroups').value.split('\n').map(l => l.trim()).filter(l => l),
        joinGroups: document.getElementById('warmingGroups').value.trim().length > 0
      };
      
      try {
        await api('/warming/start', 'POST', config);
        showAlert('Aquecimento iniciado!', 'success');
        loadWarmingStatus();
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    async function stopWarming() {
      const inst = document.getElementById('warmingInstance').value;
      if (!inst) return showAlert('Selecione uma instÃ¢ncia', 'error');
      
      try {
        await api('/warming/stop', 'POST', { instanceName: inst });
        showAlert('Aquecimento parado!', 'success');
        loadWarmingStatus();
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    async function loadWarmingStatus() {
      const inst = document.getElementById('warmingInstance').value;
      if (!inst) {
        document.getElementById('warmingStatus').innerHTML = '<p style="color:#666">Selecione uma instÃ¢ncia</p>';
        return;
      }
      
      try {
        const data = await api('/warming/status/' + inst);
        const div = document.getElementById('warmingStatus');
        
        if (!data.active) {
          div.innerHTML = '<div class="alert alert-info">Aquecimento nÃ£o estÃ¡ ativo para esta instÃ¢ncia</div>';
          return;
        }
        
        div.innerHTML = `
          <div class="alert alert-success">ğŸ”¥ Aquecimento ATIVO</div>
          <div class="warming-stats">
            <div class="stat-card">
              <div class="stat-value">${data.stats?.messagesSentToday || 0}</div>
              <div class="stat-label">Msgs Enviadas Hoje</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${data.stats?.messagesReceivedToday || 0}</div>
              <div class="stat-label">Msgs Recebidas Hoje</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${data.config?.messagesPerDay || 0}</div>
              <div class="stat-label">Meta DiÃ¡ria</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${data.stats?.groupsJoined?.length || 0}</div>
              <div class="stat-label">Grupos Entrou</div>
            </div>
          </div>
          <p style="margin-top:15px;color:#666;font-size:0.9rem">
            HorÃ¡rio ativo: ${data.config?.activeHours || 'N/A'} | 
            Intervalo: ${data.config?.minIntervalMinutes}-${data.config?.maxIntervalMinutes} min |
            Personalidade: ${data.config?.personality || 'N/A'}
          </p>
        `;
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    async function checkNumber() {
      const inst = document.getElementById('checkInstance').value;
      const number = document.getElementById('checkNumber').value;
      if (!inst || !number) return showAlert('Preencha todos os campos', 'error');
      
      try {
        const data = await api('/misc/check-number/' + inst + '/' + number);
        const div = document.getElementById('checkResult');
        div.innerHTML = data.exists 
          ? '<div class="alert alert-success">âœ… NÃºmero existe no WhatsApp<br><small>' + data.jid + '</small></div>'
          : '<div class="alert alert-error">âŒ NÃºmero NÃƒO estÃ¡ no WhatsApp</div>';
      } catch(e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }
    
    // ========== WEBHOOK AVANÃ‡ADO ==========
    async function configureAdvancedWebhook() {
      const inst = document.getElementById('webhookInstance').value;
      const url = document.getElementById('webhookUrl').value;

      if (!inst || !url) {
        showAlert('Preencha instÃ¢ncia e URL', 'error');
        return;
      }

      // Coletar tipos de eventos selecionados
      const eventTypes = [];
      const eventCheckboxes = [
        'webhookEventMessage',
        'webhookEventUpdate',
        'webhookEventReceipt',
        'webhookEventConnection',
        'webhookEventQr',
        'webhookEventGroup'
      ];

      eventCheckboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox.checked) {
          eventTypes.push(checkbox.value);
        }
      });

      const config = {
        url,
        enabled: true,
        maxRetries: parseInt(document.getElementById('webhookMaxRetries').value),
        retryDelay: parseInt(document.getElementById('webhookRetryDelay').value),
        timeout: parseInt(document.getElementById('webhookTimeout').value),
        eventTypes
      };

      try {
        await api('/webhook/configure', 'POST', { instanceName: inst, config });
        showAlert('Webhook avanÃ§ado configurado com sucesso!', 'success');
        loadWebhookConfig();
      } catch (e) {
        showAlert('Erro ao configurar: ' + e.message, 'error');
      }
    }

    async function loadWebhookConfig() {
      const inst = document.getElementById('webhookInstance').value;
      if (!inst) return;

      try {
        const data = await api(`/webhook/${inst}`, 'GET');

        if (data.advancedConfig) {
          const config = data.advancedConfig;

          document.getElementById('webhookUrl').value = config.url || '';
          document.getElementById('webhookMaxRetries').value = config.retryConfig?.maxRetries || 3;
          document.getElementById('webhookRetryDelay').value = config.retryConfig?.retryDelay || 5000;
          document.getElementById('webhookTimeout').value = config.timeout || 30000;

          // Marcar checkboxes de eventos
          const eventTypes = config.eventTypes || [];
          document.getElementById('webhookEventMessage').checked = eventTypes.includes('message');
          document.getElementById('webhookEventUpdate').checked = eventTypes.includes('message.update');
          document.getElementById('webhookEventReceipt').checked = eventTypes.includes('message.receipt');
          document.getElementById('webhookEventConnection').checked = eventTypes.includes('connection.update');
          document.getElementById('webhookEventQr').checked = eventTypes.includes('qr');
          document.getElementById('webhookEventGroup').checked = eventTypes.includes('group-participants.update');

          document.getElementById('webhookInfo').innerHTML =
            `<div class="alert alert-success">âœ… ConfiguraÃ§Ã£o carregada - Ãšltima atualizaÃ§Ã£o: ${new Date(config.updatedAt).toLocaleString('pt-BR')}</div>`;
        }
      } catch (e) {
        // Webhook nÃ£o configurado ainda
        document.getElementById('webhookInfo').innerHTML = '';
      }
    }

    async function testWebhook() {
      const inst = document.getElementById('webhookInstance').value;
      const url = document.getElementById('webhookUrl').value;

      if (!inst || !url) {
        showAlert('Preencha instÃ¢ncia e URL', 'error');
        return;
      }

      showAlert('Testando webhook...', 'info');

      try {
        const result = await api(`/webhook/test/${inst}`, 'POST', { url });

        if (result.success) {
          showAlert(`âœ… Webhook testado com sucesso! DuraÃ§Ã£o: ${result.result.duration}ms`, 'success');
        } else {
          showAlert(`âŒ Falha no teste: ${result.result.error}`, 'error');
        }
      } catch (e) {
        showAlert('Erro ao testar: ' + e.message, 'error');
      }
    }

    async function loadWebhookLogs() {
      const inst = document.getElementById('webhookInstance').value;
      if (!inst) {
        showAlert('Selecione uma instÃ¢ncia', 'error');
        return;
      }

      const status = document.getElementById('webhookLogStatus').value;
      const limit = document.getElementById('webhookLogLimit').value;

      try {
        const params = new URLSearchParams();
        if (status) params.append('status', status);
        if (limit) params.append('limit', limit);

        const data = await api(`/webhook/logs/${inst}?${params}`, 'GET');

        const logsCard = document.getElementById('webhookLogsCard');
        const logsList = document.getElementById('webhookLogsList');

        logsCard.style.display = 'block';

        if (!data.logs || data.logs.length === 0) {
          logsList.innerHTML = '<p style="color:#666">Nenhum log encontrado</p>';
          return;
        }

        let html = '<table style="width:100%;border-collapse:collapse;font-size:0.85rem">';
        html += '<thead><tr style="background:#f8f9fa"><th style="padding:8px;text-align:left">Data/Hora</th><th style="padding:8px;text-align:left">Evento</th><th style="padding:8px;text-align:left">Status</th><th style="padding:8px;text-align:left">CÃ³digo</th><th style="padding:8px;text-align:left">DuraÃ§Ã£o</th><th style="padding:8px;text-align:left">Tentativa</th></tr></thead>';
        html += '<tbody>';

        data.logs.forEach(log => {
          const date = new Date(log.timestamp).toLocaleString('pt-BR');
          const statusColors = {
            success: '#28a745',
            error: '#ffc107',
            failed: '#dc3545'
          };

          html += `<tr style="border-bottom:1px solid #eee">
            <td style="padding:8px">${date}</td>
            <td style="padding:8px">${log.eventType}</td>
            <td style="padding:8px"><span style="background:${statusColors[log.status]};color:white;padding:2px 8px;border-radius:8px;font-size:0.75rem">${log.status}</span></td>
            <td style="padding:8px">${log.statusCode || '-'}</td>
            <td style="padding:8px">${log.duration ? log.duration + 'ms' : '-'}</td>
            <td style="padding:8px">${log.attempt || '-'}</td>
          </tr>`;
        });

        html += '</tbody></table>';
        logsList.innerHTML = html;
      } catch (e) {
        showAlert('Erro ao carregar logs: ' + e.message, 'error');
      }
    }

    async function clearWebhookLogs() {
      const inst = document.getElementById('webhookInstance').value;
      if (!inst) {
        showAlert('Selecione uma instÃ¢ncia', 'error');
        return;
      }

      if (!confirm('Deseja limpar todos os logs de webhook?')) return;

      try {
        await api(`/webhook/logs/${inst}`, 'DELETE');
        showAlert('Logs limpos com sucesso!', 'success');
        document.getElementById('webhookLogsList').innerHTML = '<p style="color:#666">Nenhum log encontrado</p>';
      } catch (e) {
        showAlert('Erro ao limpar logs: ' + e.message, 'error');
      }
    }

    async function loadWebhookStats() {
      const inst = document.getElementById('webhookInstance').value;
      if (!inst) {
        showAlert('Selecione uma instÃ¢ncia', 'error');
        return;
      }

      const period = document.getElementById('webhookStatsPeriod').value;

      try {
        const data = await api(`/webhook/stats/${inst}?period=${period}`, 'GET');

        const statsCard = document.getElementById('webhookStatsCard');
        const statsDisplay = document.getElementById('webhookStatsDisplay');

        statsCard.style.display = 'block';

        const stats = data.stats;

        let html = '<div class="warming-stats">';
        html += `<div class="stat-card"><div class="stat-value">${stats.total}</div><div class="stat-label">Total</div></div>`;
        html += `<div class="stat-card"><div class="stat-value" style="color:#28a745">${stats.success}</div><div class="stat-label">Sucesso</div></div>`;
        html += `<div class="stat-card"><div class="stat-value" style="color:#dc3545">${stats.error + stats.failed}</div><div class="stat-label">Erros</div></div>`;
        html += `<div class="stat-card"><div class="stat-value">${stats.successRate}%</div><div class="stat-label">Taxa de Sucesso</div></div>`;
        html += `<div class="stat-card"><div class="stat-value">${stats.avgDuration}ms</div><div class="stat-label">DuraÃ§Ã£o MÃ©dia</div></div>`;
        html += '</div>';

        if (Object.keys(stats.byEventType).length > 0) {
          html += '<div class="section-title">Por Tipo de Evento</div>';
          html += '<table style="width:100%;border-collapse:collapse;margin-top:10px">';
          html += '<thead><tr style="background:#f8f9fa"><th style="padding:10px;text-align:left">Evento</th><th style="padding:10px">Total</th><th style="padding:10px">Sucesso</th><th style="padding:10px">Erro</th></tr></thead>';
          html += '<tbody>';

          Object.entries(stats.byEventType).forEach(([eventType, counts]) => {
            html += `<tr style="border-bottom:1px solid #eee">
              <td style="padding:10px">${eventType}</td>
              <td style="padding:10px;text-align:center">${counts.total}</td>
              <td style="padding:10px;text-align:center;color:#28a745">${counts.success}</td>
              <td style="padding:10px;text-align:center;color:#dc3545">${counts.error}</td>
            </tr>`;
          });

          html += '</tbody></table>';
        }

        statsDisplay.innerHTML = html;
      } catch (e) {
        showAlert('Erro ao carregar estatÃ­sticas: ' + e.message, 'error');
      }
    }

    // ========== CONTATOS ==========
    async function loadContacts() {
      const instance = document.getElementById('contactsInstance').value;
      if (!instance) {
        document.getElementById('contactsList').innerHTML = '<p style="color:#666">Selecione uma instÃ¢ncia</p>';
        return;
      }

      try {
        const data = await api(`/contacts/list/${instance}`, 'GET');
        const contactsDiv = document.getElementById('contactsList');

        if (!data.contacts || data.contacts.length === 0) {
          contactsDiv.innerHTML = '<p style="color:#666">Nenhum contato encontrado</p>';
          return;
        }

        let html = `<p style="margin-bottom:10px"><strong>Total: ${data.contacts.length} contatos</strong></p>`;
        html += '<table style="width:100%;border-collapse:collapse;font-size:0.9rem">';
        html += '<thead><tr style="background:#f8f9fa"><th style="padding:10px;text-align:left">Nome</th><th style="padding:10px;text-align:left">NÃºmero</th></tr></thead>';
        html += '<tbody>';

        data.contacts.slice(0, 50).forEach(contact => {
          html += `<tr style="border-bottom:1px solid #eee">
            <td style="padding:10px">${contact.name || '-'}</td>
            <td style="padding:10px">${contact.number}</td>
          </tr>`;
        });

        if (data.contacts.length > 50) {
          html += `<tr><td colspan="2" style="padding:10px;text-align:center;color:#666">Mostrando 50 de ${data.contacts.length} contatos</td></tr>`;
        }

        html += '</tbody></table>';
        contactsDiv.innerHTML = html;
      } catch (e) {
        document.getElementById('contactsList').innerHTML = `<p style="color:#dc3545">Erro ao carregar: ${e.message}</p>`;
      }
    }

    async function exportContacts() {
      const instance = document.getElementById('importExportInstance').value;
      const format = document.getElementById('exportFormat').value;

      if (!instance) {
        showAlert('Selecione uma instÃ¢ncia', 'error');
        return;
      }

      try {
        const url = `${API_URL()}/contacts/export/${instance}?format=${format}`;
        const res = await fetch(url, {
          headers: { 'x-api-key': API_KEY() }
        });

        if (!res.ok) throw new Error('Erro ao exportar');

        const blob = await res.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = `contacts-${instance}.${format === 'excel' ? 'xlsx' : format}`;
        document.body.appendChild(a);
        a.click();
        a.remove();

        showAlert('Contatos exportados com sucesso!', 'success');
      } catch (e) {
        showAlert('Erro ao exportar: ' + e.message, 'error');
      }
    }

    async function syncContacts() {
      const instance = document.getElementById('importExportInstance').value;
      if (!instance) {
        showAlert('Selecione uma instÃ¢ncia', 'error');
        return;
      }

      try {
        await api(`/contacts/sync/${instance}`, 'POST');
        showAlert('SincronizaÃ§Ã£o iniciada! Aguarde alguns segundos e atualize a lista.', 'success');
      } catch (e) {
        showAlert('Erro ao sincronizar: ' + e.message, 'error');
      }
    }

    // ========== AUTO-RESPOSTA ==========
    async function configureAutoResponder() {
      const instance = document.getElementById('autoresponderInstance').value;
      const groqKey = document.getElementById('autoresponderGroqKey').value;

      if (!instance || !groqKey) {
        showAlert('Preencha instÃ¢ncia e chave API', 'error');
        return;
      }

      const config = {
        groqApiKey: groqKey,
        model: document.getElementById('autoresponderModel').value,
        respondTo: document.getElementById('autoresponderRespondTo').value,
        personality: document.getElementById('autoresponderPersonality').value,
        context: document.getElementById('autoresponderContext').value,
        maxResponseLength: parseInt(document.getElementById('autoresponderMaxLength').value),
        maxResponsesPerDay: parseInt(document.getElementById('autoresponderMaxResponses').value),
        activeHours: {
          start: parseInt(document.getElementById('autoresponderStartHour').value),
          end: parseInt(document.getElementById('autoresponderEndHour').value)
        },
        enabledOnWeekends: document.getElementById('autoresponderWeekend').checked
      };

      try {
        await api('/autoresponder/configure', 'POST', { instanceName: instance, config });
        showAlert('Auto-resposta configurada com sucesso!', 'success');
      } catch (e) {
        showAlert('Erro ao configurar: ' + e.message, 'error');
      }
    }

    async function enableAutoResponder() {
      const instance = document.getElementById('autoresponderInstance').value;
      if (!instance) {
        showAlert('Selecione uma instÃ¢ncia', 'error');
        return;
      }

      try {
        await api(`/autoresponder/enable/${instance}`, 'POST');
        showAlert('Auto-resposta ativada!', 'success');
      } catch (e) {
        showAlert('Erro ao ativar: ' + e.message, 'error');
      }
    }

    async function disableAutoResponder() {
      const instance = document.getElementById('autoresponderInstance').value;
      if (!instance) {
        showAlert('Selecione uma instÃ¢ncia', 'error');
        return;
      }

      try {
        await api(`/autoresponder/disable/${instance}`, 'POST');
        showAlert('Auto-resposta desativada!', 'success');
      } catch (e) {
        showAlert('Erro ao desativar: ' + e.message, 'error');
      }
    }

    async function loadAutoResponderStats() {
      const instance = document.getElementById('autoresponderInstance').value;
      if (!instance) {
        showAlert('Selecione uma instÃ¢ncia', 'error');
        return;
      }

      try {
        const data = await api(`/autoresponder/stats/${instance}`, 'GET');
        const statsDiv = document.getElementById('autoresponderStats');

        let html = '<div class="warming-stats">';
        html += `<div class="stat-card"><div class="stat-value">${data.totalResponses || 0}</div><div class="stat-label">Respostas Enviadas</div></div>`;
        html += `<div class="stat-card"><div class="stat-value">${data.uniqueContacts || 0}</div><div class="stat-label">Contatos Ãšnicos</div></div>`;
        html += `<div class="stat-card"><div class="stat-value ${data.enabled ? 'style="color:#28a745"' : 'style="color:#dc3545"'}">${data.enabled ? 'Ativo' : 'Inativo'}</div><div class="stat-label">Status</div></div>`;
        html += '</div>';

        statsDiv.innerHTML = html;
      } catch (e) {
        document.getElementById('autoresponderStats').innerHTML = `<p style="color:#dc3545">Erro: ${e.message}</p>`;
      }
    }

    // ========== BROADCAST ==========
    async function createBroadcast() {
      const instance = document.getElementById('broadcastInstance').value;
      const name = document.getElementById('broadcastName').value;
      const numbersText = document.getElementById('broadcastNumbers').value;
      const message = document.getElementById('broadcastMessage').value;

      if (!instance || !name || !numbersText || !message) {
        showAlert('Preencha todos os campos', 'error');
        return;
      }

      const recipients = numbersText.split('\n').map(n => n.trim()).filter(n => n);

      const campaign = {
        instanceName: instance,
        name,
        recipients,
        message,
        config: {
          minDelay: parseInt(document.getElementById('broadcastMinDelay').value),
          maxDelay: parseInt(document.getElementById('broadcastMaxDelay').value),
          maxMessagesPerHour: parseInt(document.getElementById('broadcastMaxPerHour').value),
          simulateTyping: document.getElementById('broadcastSimulateTyping').checked
        }
      };

      try {
        const result = await api('/broadcast/create', 'POST', campaign);
        showAlert(`Campanha "${name}" criada! ID: ${result.campaignId}`, 'success');

        // Limpar formulÃ¡rio
        document.getElementById('broadcastName').value = '';
        document.getElementById('broadcastNumbers').value = '';
        document.getElementById('broadcastMessage').value = '';

        loadBroadcasts();
      } catch (e) {
        showAlert('Erro ao criar campanha: ' + e.message, 'error');
      }
    }

    async function loadBroadcasts() {
      const instance = document.getElementById('broadcastFilterInstance').value;
      if (!instance) {
        document.getElementById('broadcastList').innerHTML = '<p style="color:#666">Selecione uma instÃ¢ncia</p>';
        return;
      }

      try {
        const data = await api(`/broadcast/campaigns/${instance}`, 'GET');
        const listDiv = document.getElementById('broadcastList');

        if (!data.campaigns || data.campaigns.length === 0) {
          listDiv.innerHTML = '<p style="color:#666">Nenhuma campanha encontrada</p>';
          return;
        }

        let html = '<table style="width:100%;border-collapse:collapse;font-size:0.9rem">';
        html += '<thead><tr style="background:#f8f9fa"><th style="padding:10px;text-align:left">Nome</th><th style="padding:10px;text-align:left">Status</th><th style="padding:10px;text-align:left">Progresso</th><th style="padding:10px;text-align:left">AÃ§Ãµes</th></tr></thead>';
        html += '<tbody>';

        data.campaigns.forEach(camp => {
          const progress = `${camp.sent}/${camp.total}`;
          const statusColors = {
            pending: '#6c757d',
            running: '#28a745',
            paused: '#ffc107',
            completed: '#17a2b8',
            failed: '#dc3545'
          };

          html += `<tr style="border-bottom:1px solid #eee">
            <td style="padding:10px">${camp.name}</td>
            <td style="padding:10px"><span style="background:${statusColors[camp.status]};color:white;padding:3px 10px;border-radius:10px;font-size:0.8rem">${camp.status}</span></td>
            <td style="padding:10px">${progress}</td>
            <td style="padding:10px">
              ${camp.status === 'pending' ? `<button class="btn btn-primary btn-sm" onclick="startBroadcast('${camp.id}')">â–¶ï¸ Iniciar</button>` : ''}
              ${camp.status === 'running' ? `<button class="btn btn-secondary btn-sm" onclick="pauseBroadcast('${camp.id}')">â¸ï¸ Pausar</button>` : ''}
              ${camp.status === 'paused' ? `<button class="btn btn-primary btn-sm" onclick="resumeBroadcast('${camp.id}')">â–¶ï¸ Retomar</button>` : ''}
              ${camp.status !== 'completed' ? `<button class="btn btn-danger btn-sm" onclick="cancelBroadcast('${camp.id}')">âŒ Cancelar</button>` : ''}
            </td>
          </tr>`;
        });

        html += '</tbody></table>';
        listDiv.innerHTML = html;
      } catch (e) {
        document.getElementById('broadcastList').innerHTML = `<p style="color:#dc3545">Erro: ${e.message}</p>`;
      }
    }

    async function startBroadcast(campaignId) {
      try {
        await api(`/broadcast/start/${campaignId}`, 'POST');
        showAlert('Campanha iniciada!', 'success');
        loadBroadcasts();
      } catch (e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }

    async function pauseBroadcast(campaignId) {
      try {
        await api(`/broadcast/pause/${campaignId}`, 'POST');
        showAlert('Campanha pausada!', 'success');
        loadBroadcasts();
      } catch (e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }

    async function resumeBroadcast(campaignId) {
      try {
        await api(`/broadcast/resume/${campaignId}`, 'POST');
        showAlert('Campanha retomada!', 'success');
        loadBroadcasts();
      } catch (e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }

    async function cancelBroadcast(campaignId) {
      if (!confirm('Deseja cancelar esta campanha?')) return;

      try {
        await api(`/broadcast/cancel/${campaignId}`, 'POST');
        showAlert('Campanha cancelada!', 'success');
        loadBroadcasts();
      } catch (e) {
        showAlert('Erro: ' + e.message, 'error');
      }
    }

    // ========== AGENDAMENTO ==========
    function updateScheduleFields() {
      const type = document.getElementById('scheduleType').value;
      const fieldsDiv = document.getElementById('scheduleFields');

      let html = '';
      if (type === 'text') {
        html = `
          <div class="form-group">
            <label>Mensagem</label>
            <textarea id="scheduleText" placeholder="Digite a mensagem a ser enviada"></textarea>
          </div>
        `;
      } else if (type === 'image') {
        html = `
          <div class="form-group">
            <label>URL da Imagem</label>
            <input type="text" id="scheduleImageUrl" placeholder="https://...">
          </div>
          <div class="form-group">
            <label>Legenda (opcional)</label>
            <textarea id="scheduleCaption" placeholder="Texto da legenda"></textarea>
          </div>
        `;
      } else if (type === 'document') {
        html = `
          <div class="form-group">
            <label>URL do Documento</label>
            <input type="text" id="scheduleDocUrl" placeholder="https://...">
          </div>
          <div class="form-group">
            <label>Nome do Arquivo</label>
            <input type="text" id="scheduleFileName" placeholder="documento.pdf">
          </div>
          <div class="form-group">
            <label>MIME Type</label>
            <input type="text" id="scheduleMimetype" placeholder="application/pdf">
          </div>
        `;
      } else if (type === 'audio') {
        html = `
          <div class="form-group">
            <label>URL do Ãudio</label>
            <input type="text" id="scheduleAudioUrl" placeholder="https://...">
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="schedulePtt" checked> PTT (Ãudio de voz)
            </label>
          </div>
        `;
      } else if (type === 'video') {
        html = `
          <div class="form-group">
            <label>URL do VÃ­deo</label>
            <input type="text" id="scheduleVideoUrl" placeholder="https://...">
          </div>
          <div class="form-group">
            <label>Legenda (opcional)</label>
            <textarea id="scheduleCaption" placeholder="Texto da legenda"></textarea>
          </div>
        `;
      }

      fieldsDiv.innerHTML = html;
    }

    async function createSchedule() {
      const instance = document.getElementById('scheduleInstance').value;
      const to = document.getElementById('scheduleTo').value;
      const dateTime = document.getElementById('scheduleDateTime').value;
      const type = document.getElementById('scheduleType').value;

      if (!instance || !to || !dateTime) {
        showAlert('Preencha todos os campos obrigatÃ³rios', 'error');
        return;
      }

      const scheduledAt = new Date(dateTime).toISOString();

      let content = {};
      if (type === 'text') {
        content = { text: document.getElementById('scheduleText').value };
      } else if (type === 'image') {
        content = {
          imageUrl: document.getElementById('scheduleImageUrl').value,
          caption: document.getElementById('scheduleCaption').value || ''
        };
      } else if (type === 'document') {
        content = {
          documentUrl: document.getElementById('scheduleDocUrl').value,
          fileName: document.getElementById('scheduleFileName').value,
          mimetype: document.getElementById('scheduleMimetype').value
        };
      } else if (type === 'audio') {
        content = {
          audioUrl: document.getElementById('scheduleAudioUrl').value,
          ptt: document.getElementById('schedulePtt').checked
        };
      } else if (type === 'video') {
        content = {
          videoUrl: document.getElementById('scheduleVideoUrl').value,
          caption: document.getElementById('scheduleCaption').value || ''
        };
      }

      try {
        const result = await api('/scheduler/schedule', 'POST', {
          instanceName: instance,
          to,
          type,
          content,
          scheduledAt
        });

        showAlert('Mensagem agendada com sucesso!', 'success');
        loadScheduledMessages();

        // Limpar formulÃ¡rio
        document.getElementById('scheduleText') && (document.getElementById('scheduleText').value = '');
        document.getElementById('scheduleDateTime').value = '';
      } catch (e) {
        showAlert('Erro ao agendar: ' + e.message, 'error');
      }
    }

    async function loadScheduledMessages() {
      const instance = document.getElementById('scheduleFilterInstance').value;
      const status = document.getElementById('scheduleFilterStatus').value;

      if (!instance) {
        document.getElementById('scheduledMessages').innerHTML = '<p style="color:#666">Selecione uma instÃ¢ncia para ver as mensagens agendadas</p>';
        return;
      }

      try {
        const params = new URLSearchParams();
        if (status) params.append('status', status);

        const data = await api(`/scheduler/list/${instance}?${params}`, 'GET');

        const messagesDiv = document.getElementById('scheduledMessages');
        if (!data.messages || data.messages.length === 0) {
          messagesDiv.innerHTML = '<p style="color:#666">Nenhuma mensagem agendada encontrada</p>';
          return;
        }

        let html = '<table style="width:100%;border-collapse:collapse;font-size:0.9rem">';
        html += '<thead><tr style="background:#f8f9fa"><th style="padding:10px;text-align:left">Data/Hora</th><th style="padding:10px;text-align:left">Para</th><th style="padding:10px;text-align:left">Tipo</th><th style="padding:10px;text-align:left">Status</th><th style="padding:10px;text-align:left">AÃ§Ãµes</th></tr></thead>';
        html += '<tbody>';

        data.messages.forEach(msg => {
          const date = new Date(msg.scheduledAt).toLocaleString('pt-BR');
          const statusColors = {
            pending: '#ffc107',
            sent: '#28a745',
            failed: '#dc3545',
            cancelled: '#6c757d'
          };
          const statusText = {
            pending: 'Pendente',
            sent: 'Enviado',
            failed: 'Falhado',
            cancelled: 'Cancelado'
          };

          html += `<tr style="border-bottom:1px solid #eee">
            <td style="padding:10px">${date}</td>
            <td style="padding:10px">${msg.to}</td>
            <td style="padding:10px">${msg.type}</td>
            <td style="padding:10px"><span style="background:${statusColors[msg.status]};color:white;padding:3px 10px;border-radius:10px;font-size:0.8rem">${statusText[msg.status]}</span></td>
            <td style="padding:10px">
              ${msg.status === 'pending' ? `<button class="btn btn-danger btn-sm" onclick="cancelSchedule('${msg.id}')">Cancelar</button>` : '-'}
            </td>
          </tr>`;
        });

        html += '</tbody></table>';
        messagesDiv.innerHTML = html;
      } catch (e) {
        document.getElementById('scheduledMessages').innerHTML = `<p style="color:#dc3545">Erro ao carregar: ${e.message}</p>`;
      }
    }

    async function cancelSchedule(messageId) {
      if (!confirm('Deseja cancelar este agendamento?')) return;

      try {
        await api(`/scheduler/cancel/${messageId}`, 'DELETE');
        showAlert('Agendamento cancelado!', 'success');
        loadScheduledMessages();
      } catch (e) {
        showAlert('Erro ao cancelar: ' + e.message, 'error');
      }
    }

    // Carregar instÃ¢ncias ao iniciar
    setTimeout(loadInstances, 500);
  </script>
</body>
</html>
