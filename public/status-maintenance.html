<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manuten√ß√µes - WhatsBenemax</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: #f8fafc; color: #1e293b; }

    .header { background: #fff; border-bottom: 1px solid #e2e8f0; padding: 20px; }
    .header-content { max-width: 900px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 1.5rem; font-weight: 700; color: #25d366; text-decoration: none; }
    .nav { display: flex; gap: 20px; align-items: center; }
    .nav a { color: #64748b; text-decoration: none; font-size: 0.9rem; }
    .nav a:hover { color: #25d366; }
    .nav a.active { color: #25d366; font-weight: 500; }

    .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }

    .page-header { text-align: center; margin-bottom: 40px; }
    .page-header h1 { font-size: 2rem; margin-bottom: 10px; }
    .page-header p { color: #64748b; }

    .section { background: #fff; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; color: #334155; }

    .maintenance { padding: 16px; background: #eff6ff; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #3b82f6; }
    .maintenance.in_progress { background: #fef3c7; border-color: #f59e0b; }
    .maintenance.completed { background: #f0fdf4; border-color: #22c55e; }
    .maintenance-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .maintenance-title { font-weight: 500; }
    .maintenance-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: #dbeafe; color: #1e40af; }
    .maintenance-badge.in_progress { background: #fef3c7; color: #92400e; }
    .maintenance-badge.completed { background: #dcfce7; color: #166534; }
    .maintenance-time { font-size: 0.8rem; color: #64748b; margin-bottom: 8px; }
    .maintenance-desc { font-size: 0.85rem; color: #475569; margin-bottom: 8px; }
    .maintenance-services { font-size: 0.8rem; color: #64748b; }
    .maintenance-services strong { color: #334155; }

    .empty-state { text-align: center; padding: 40px; color: #94a3b8; }

    .footer { text-align: center; padding: 40px 20px; color: #94a3b8; font-size: 0.85rem; }
    .footer a { color: #25d366; text-decoration: none; }

    @media (max-width: 600px) {
      .header-content { flex-direction: column; gap: 15px; }
      .nav { flex-wrap: wrap; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <a href="/status" class="logo">üì± WhatsBenemax</a>
      <nav class="nav">
        <a href="/status">Status</a>
        <a href="/status/maintenance" class="active">Manuten√ß√µes</a>
        <a href="/status/subscribe">Receber Alertas</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <div class="page-header">
      <h1>üîß Manuten√ß√µes</h1>
      <p>Visualize manuten√ß√µes agendadas e hist√≥rico de manuten√ß√µes realizadas</p>
    </div>

    <div class="section">
      <h2 class="section-title">Manuten√ß√µes em Andamento</h2>
      <div id="inProgressList">
        <p class="empty-state">Carregando...</p>
      </div>
    </div>

    <div class="section">
      <h2 class="section-title">Pr√≥ximas Manuten√ß√µes</h2>
      <div id="upcomingList">
        <p class="empty-state">Carregando...</p>
      </div>
    </div>

    <div class="section">
      <h2 class="section-title">Hist√≥rico de Manuten√ß√µes</h2>
      <div id="historyList">
        <p class="empty-state">Carregando...</p>
      </div>
    </div>
  </div>

  <div class="footer">
    Powered by <a href="/docs">WhatsBenemax API</a> ¬∑ <a href="/status">P√°gina de Status</a>
  </div>

  <script>
    const statusLabels = {
      scheduled: 'Agendada',
      in_progress: 'Em andamento',
      completed: 'Conclu√≠da',
      cancelled: 'Cancelada'
    };

    async function loadMaintenances() {
      try {
        // Load all maintenances
        const response = await fetch('/status/api/maintenances?type=all');
        const data = await response.json();

        const now = new Date();
        const inProgress = [];
        const upcoming = [];

        // Separate maintenances
        for (const m of data.maintenances || []) {
          const start = new Date(m.scheduled_start);
          const end = new Date(m.scheduled_end);

          if (m.status === 'in_progress') {
            inProgress.push(m);
          } else if (m.status === 'scheduled' && start > now) {
            upcoming.push(m);
          }
        }

        // Render in progress
        const inProgressContainer = document.getElementById('inProgressList');
        if (inProgress.length === 0) {
          inProgressContainer.innerHTML = '<p class="empty-state">Nenhuma manuten√ß√£o em andamento</p>';
        } else {
          inProgressContainer.innerHTML = inProgress.map(m => renderMaintenance(m)).join('');
        }

        // Render upcoming
        const upcomingContainer = document.getElementById('upcomingList');
        if (upcoming.length === 0) {
          upcomingContainer.innerHTML = '<p class="empty-state">Nenhuma manuten√ß√£o agendada</p>';
        } else {
          upcomingContainer.innerHTML = upcoming.map(m => renderMaintenance(m)).join('');
        }

        // Load history
        await loadHistory();

      } catch (error) {
        console.error('Erro ao carregar manuten√ß√µes:', error);
      }
    }

    async function loadHistory() {
      try {
        const response = await fetch('/status/api/maintenances?type=history');
        const data = await response.json();

        const historyContainer = document.getElementById('historyList');

        if (!data.maintenances || data.maintenances.length === 0) {
          historyContainer.innerHTML = '<p class="empty-state">Nenhuma manuten√ß√£o no hist√≥rico</p>';
          return;
        }

        historyContainer.innerHTML = data.maintenances.map(m => renderMaintenance(m)).join('');
      } catch (error) {
        console.error('Erro ao carregar hist√≥rico:', error);
      }
    }

    function renderMaintenance(m) {
      const services = m.service_names ? m.service_names.join(', ') : 'Todos os servi√ßos';
      const start = new Date(m.scheduled_start);
      const end = new Date(m.scheduled_end);

      let timeInfo = '';
      if (m.status === 'in_progress') {
        timeInfo = `Em andamento desde ${start.toLocaleString('pt-BR')} ¬∑ T√©rmino previsto: ${end.toLocaleString('pt-BR')}`;
      } else if (m.status === 'scheduled') {
        timeInfo = `Agendada para ${start.toLocaleString('pt-BR')} ¬∑ Dura√ß√£o prevista: ${formatDuration(start, end)}`;
      } else if (m.status === 'completed') {
        timeInfo = `Realizada em ${start.toLocaleDateString('pt-BR')} ¬∑ Dura√ß√£o: ${formatDuration(start, end)}`;
      }

      return `
        <div class="maintenance ${m.status}">
          <div class="maintenance-header">
            <span class="maintenance-title">${m.title}</span>
            <span class="maintenance-badge ${m.status}">${statusLabels[m.status] || m.status}</span>
          </div>
          <div class="maintenance-time">${timeInfo}</div>
          ${m.description ? `<div class="maintenance-desc">${m.description}</div>` : ''}
          <div class="maintenance-services"><strong>Servi√ßos afetados:</strong> ${services}</div>
        </div>
      `;
    }

    function formatDuration(start, end) {
      const diff = end - start;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

      if (hours > 0) {
        return `${hours}h${minutes > 0 ? ` ${minutes}min` : ''}`;
      }
      return `${minutes}min`;
    }

    loadMaintenances();
    setInterval(loadMaintenances, 60000); // Refresh every minute
  </script>
</body>
</html>
