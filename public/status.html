<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Status - WhatsBenemax</title>
  <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/status/rss">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: #f8fafc; color: #1e293b; }

    .header { background: #fff; border-bottom: 1px solid #e2e8f0; padding: 20px; }
    .header-content { max-width: 900px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 1.5rem; font-weight: 700; color: #25d366; text-decoration: none; }
    .nav { display: flex; gap: 20px; align-items: center; }
    .nav a { color: #64748b; text-decoration: none; font-size: 0.9rem; }
    .nav a:hover { color: #25d366; }
    .nav .rss { color: #f97316; }

    .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }

    .overall-status { text-align: center; margin-bottom: 40px; }
    .overall-status h1 { font-size: 2rem; margin-bottom: 10px; }
    .overall-status .badge { display: inline-block; padding: 8px 20px; border-radius: 20px; font-weight: 500; }
    .badge.operational { background: #dcfce7; color: #166534; }
    .badge.degraded { background: #fef3c7; color: #92400e; }
    .badge.outage { background: #fee2e2; color: #991b1b; }
    .badge.maintenance { background: #dbeafe; color: #1e40af; }
    .last-updated { color: #94a3b8; font-size: 0.85rem; margin-top: 10px; }

    .section { background: #fff; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; color: #334155; display: flex; justify-content: space-between; align-items: center; }
    .section-title a { font-size: 0.85rem; color: #25d366; text-decoration: none; }

    .service { padding: 16px 0; border-bottom: 1px solid #f1f5f9; }
    .service:last-child { border-bottom: none; }
    .service-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .service-name { font-weight: 500; }
    .service-status { font-size: 0.85rem; display: flex; align-items: center; gap: 6px; }
    .service-status .dot { width: 8px; height: 8px; border-radius: 50%; }
    .service-status.operational .dot { background: #22c55e; }
    .service-status.degraded .dot { background: #f59e0b; }
    .service-status.outage .dot { background: #ef4444; }
    .service-status.unknown .dot { background: #94a3b8; }
    .service-description { font-size: 0.85rem; color: #64748b; margin-bottom: 12px; }
    .service-uptime { font-size: 0.85rem; color: #64748b; margin-bottom: 8px; }

    .uptime-bar { display: flex; gap: 2px; height: 32px; }
    .uptime-day { flex: 1; border-radius: 3px; cursor: pointer; transition: transform 0.2s; position: relative; }
    .uptime-day:hover { transform: scaleY(1.2); }
    .uptime-day.operational { background: #22c55e; }
    .uptime-day.degraded { background: #f59e0b; }
    .uptime-day.outage { background: #ef4444; }
    .uptime-day.no-data { background: #e2e8f0; }

    .uptime-labels { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; color: #94a3b8; }

    .tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 6px 10px; border-radius: 6px; font-size: 0.75rem; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 10; margin-bottom: 5px; }
    .uptime-day:hover .tooltip { opacity: 1; }

    .incidents-empty { text-align: center; padding: 20px; color: #94a3b8; }
    .incident { padding: 16px; background: #fefce8; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #eab308; }
    .incident.resolved { background: #f0fdf4; border-color: #22c55e; }
    .incident.critical { background: #fef2f2; border-color: #ef4444; }
    .incident-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .incident-title { font-weight: 500; }
    .incident-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: #fef3c7; color: #92400e; }
    .incident-badge.critical { background: #fee2e2; color: #991b1b; }
    .incident-badge.resolved { background: #dcfce7; color: #166534; }
    .incident-time { font-size: 0.8rem; color: #64748b; }
    .incident-desc { font-size: 0.85rem; color: #475569; margin-top: 8px; }

    .maintenance { padding: 16px; background: #eff6ff; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #3b82f6; }
    .maintenance-title { font-weight: 500; margin-bottom: 4px; }
    .maintenance-time { font-size: 0.8rem; color: #64748b; }

    .subscribe-banner { background: linear-gradient(135deg, #25d366, #128c7e); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 24px; }
    .subscribe-banner h3 { margin-bottom: 8px; }
    .subscribe-banner p { opacity: 0.9; margin-bottom: 16px; font-size: 0.9rem; }
    .subscribe-banner a { display: inline-block; background: white; color: #128c7e; padding: 10px 24px; border-radius: 8px; text-decoration: none; font-weight: 500; }

    .footer { text-align: center; padding: 40px 20px; color: #94a3b8; font-size: 0.85rem; }
    .footer a { color: #25d366; text-decoration: none; }

    @media (max-width: 600px) {
      .header-content { flex-direction: column; gap: 15px; }
      .uptime-bar { height: 24px; }
      .nav { flex-wrap: wrap; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <a href="/status" class="logo">üì± WhatsBenemax</a>
      <nav class="nav">
        <a href="/status">Status</a>
        <a href="/status/maintenance">Manuten√ß√µes</a>
        <a href="/status/subscribe">Receber Alertas</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <div class="overall-status">
      <h1 id="overallTitle">Verificando status...</h1>
      <span id="overallBadge" class="badge">Carregando</span>
      <p class="last-updated">√öltima atualiza√ß√£o: <span id="lastUpdated">-</span></p>
    </div>

    <div class="subscribe-banner">
      <h3>üîî Receba alertas de status</h3>
      <p>Seja notificado por email ou Telegram quando houver incidentes ou manuten√ß√µes.</p>
      <a href="/status/subscribe">Inscrever-se</a>
    </div>

    <div id="maintenanceSection" class="section" style="display: none;">
      <h2 class="section-title">üîß Manuten√ß√µes Agendadas <a href="/status/maintenance">Ver todas</a></h2>
      <div id="maintenancesList"></div>
    </div>

    <div id="incidentsSection" class="section" style="display: none;">
      <h2 class="section-title">‚ö†Ô∏è Incidentes Ativos</h2>
      <div id="incidentsList"></div>
    </div>

    <div class="section">
      <h2 class="section-title">Servi√ßos</h2>
      <div id="servicesList">
        <p style="text-align: center; color: #94a3b8;">Carregando servi√ßos...</p>
      </div>
    </div>

    <div class="section">
      <h2 class="section-title">üìú Hist√≥rico de Incidentes <a href="/status/rss">RSS Feed</a></h2>
      <div id="incidentHistory">
        <p class="incidents-empty">Carregando...</p>
      </div>
    </div>
  </div>

  <div class="footer">
    Powered by <a href="/docs">WhatsBenemax API</a> ¬∑ <a href="/status/rss">RSS Feed</a>
  </div>

  <script>
    const statusLabels = {
      operational: 'Operacional',
      degraded: 'Degradado',
      outage: 'Fora do ar',
      maintenance: 'Em manuten√ß√£o',
      unknown: 'Desconhecido'
    };

    const overallLabels = {
      operational: 'Todos os servi√ßos operacionais',
      degraded: 'Alguns servi√ßos com problemas',
      outage: 'Interrup√ß√£o em andamento',
      maintenance: 'Manuten√ß√£o em andamento'
    };

    async function loadStatus() {
      try {
        const response = await fetch('/status/api/current');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        console.log('Status data loaded:', data);

        document.getElementById('overallTitle').textContent = overallLabels[data.overall] || 'Status desconhecido';
        const badge = document.getElementById('overallBadge');
        badge.textContent = statusLabels[data.overall];
        badge.className = 'badge ' + data.overall;
        document.getElementById('lastUpdated').textContent = new Date(data.lastUpdated).toLocaleString('pt-BR');

        if (data.maintenances && data.maintenances.length > 0) {
          document.getElementById('maintenanceSection').style.display = 'block';
          document.getElementById('maintenancesList').innerHTML = data.maintenances.slice(0, 3).map(m => `
            <div class="maintenance">
              <div class="maintenance-title">${m.title}</div>
              <div class="maintenance-time">
                ${m.status === 'in_progress' ? 'üîÑ Em andamento' : 'üìÖ Agendada'}:
                ${new Date(m.scheduled_start).toLocaleString('pt-BR')} - ${new Date(m.scheduled_end).toLocaleString('pt-BR')}
              </div>
            </div>
          `).join('');
        }

        if (data.incidents && data.incidents.length > 0) {
          document.getElementById('incidentsSection').style.display = 'block';
          document.getElementById('incidentsList').innerHTML = data.incidents.map(i => `
            <div class="incident ${i.severity}">
              <div class="incident-header">
                <span class="incident-title">${i.title}</span>
                <span class="incident-badge ${i.severity}">${i.severity}</span>
              </div>
              <div class="incident-time">${i.service_name} ¬∑ ${new Date(i.started_at).toLocaleString('pt-BR')}</div>
              ${i.description ? `<div class="incident-desc">${i.description}</div>` : ''}
            </div>
          `).join('');
        }

        if (data.services && Array.isArray(data.services)) {
          await renderServices(data.services);
        } else {
          console.warn('No services data received');
          document.getElementById('servicesList').innerHTML = '<p class="empty-state">Nenhum servi√ßo configurado ainda</p>';
        }
        await loadIncidentHistory();

      } catch (error) {
        console.error('Erro ao carregar status:', error);
        document.getElementById('overallTitle').textContent = 'Erro ao carregar status';
        document.getElementById('lastUpdated').textContent = error.message;
        document.getElementById('servicesList').innerHTML = `
          <div style="text-align: center; padding: 40px; color: #ef4444;">
            <p><strong>‚ö†Ô∏è Erro ao carregar dados</strong></p>
            <p style="font-size: 0.9rem;">${error.message}</p>
            <p style="font-size: 0.8rem; color: #64748b; margin-top: 12px;">
              Verifique o console do navegador (F12) para mais detalhes
            </p>
          </div>
        `;
      }
    }

    async function renderServices(services) {
      const container = document.getElementById('servicesList');
      let html = '';

      for (const service of services) {
        let historyHtml = '';
        let uptime = '100.000';

        try {
          const histResponse = await fetch(`/status/api/history/${service.slug}?days=90`);
          const histData = await histResponse.json();
          uptime = parseFloat(histData.uptime).toFixed(3);

          const days = [];
          for (let i = 89; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            const dayData = histData.history.find(h => h.date && h.date.split('T')[0] === dateStr);

            let status = 'no-data';
            let tooltip = date.toLocaleDateString('pt-BR');

            if (dayData) {
              const uptimePct = parseFloat(dayData.uptime_percentage);
              if (uptimePct >= 99) status = 'operational';
              else if (uptimePct >= 95) status = 'degraded';
              else status = 'outage';
              tooltip += ` - ${uptimePct.toFixed(2)}%`;
            }

            days.push(`<div class="uptime-day ${status}"><span class="tooltip">${tooltip}</span></div>`);
          }
          historyHtml = days.join('');
        } catch (e) {
          historyHtml = Array(90).fill('<div class="uptime-day no-data"></div>').join('');
        }

        html += `
          <div class="service">
            <div class="service-header">
              <span class="service-name">${service.name}</span>
              <span class="service-status ${service.status || 'unknown'}">
                <span class="dot"></span>
                ${statusLabels[service.status] || 'Desconhecido'}
              </span>
            </div>
            <div class="service-description">${service.description || ''}</div>
            <div class="service-uptime">${uptime}% uptime nos √∫ltimos 90 dias</div>
            <div class="uptime-bar">${historyHtml}</div>
            <div class="uptime-labels">
              <span>90 dias atr√°s</span>
              <span>Hoje</span>
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    async function loadIncidentHistory() {
      try {
        const response = await fetch('/status/api/incidents?limit=10');
        const data = await response.json();

        const container = document.getElementById('incidentHistory');

        if (!data.incidents || data.incidents.length === 0) {
          container.innerHTML = '<p class="incidents-empty">Nenhum incidente registrado</p>';
          return;
        }

        container.innerHTML = data.incidents.map(i => `
          <div class="incident ${i.status === 'resolved' ? 'resolved' : i.severity}">
            <div class="incident-header">
              <span class="incident-title">${i.title}</span>
              <span class="incident-badge ${i.status === 'resolved' ? 'resolved' : i.severity}">
                ${i.status === 'resolved' ? 'Resolvido' : i.severity}
              </span>
            </div>
            <div class="incident-time">
              ${i.service_name} ¬∑ ${new Date(i.started_at).toLocaleDateString('pt-BR')}
              ${i.resolved_at ? ` ¬∑ Resolvido em ${new Date(i.resolved_at).toLocaleDateString('pt-BR')}` : ''}
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar hist√≥rico:', error);
      }
    }

    loadStatus();
    setInterval(loadStatus, 30000);
  </script>
</body>
</html>
