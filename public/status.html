<!DOCTYPE html>
<html lang="pt-BR" class="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Status do Sistema | WhatsBenemax</title>
  <link rel="alternate" type="application/rss+xml" title="RSS Feed de Status" href="/status/rss">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;600;700&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --primary: #25D366;
      --primary-dark: #128C7E;
      --bg: #FAFBFC;
      --card-bg: #FFFFFF;
      --text-main: #1A1C1E;
      --text-muted: #64748B;
      --border: #E2E8F0;

      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
      --info: #3B82F6;

      --success-bg: #ECFDF5;
      --warning-bg: #FFFBEB;
      --danger-bg: #FEF2F2;
      --info-bg: #EFF6FF;

      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.08);

      --radius: 12px;
    }

    [data-theme="dark"] {
      --bg: #0F172A;
      --card-bg: #1E293B;
      --text-main: #F8FAFC;
      --text-muted: #94A3B8;
      --border: #334155;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
      line-height: 1.5;
      transition: background-color 0.3s ease;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    h1,
    h2,
    h3 {
      font-family: 'Outfit', sans-serif;
    }

    /* Layout */
    .header {
      background-color: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 1.25rem 2rem;
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(8px);
      background-color: rgba(var(--card-bg), 0.8);
    }

    .header-content {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      font-weight: 700;
      color: var(--text-main);
      font-size: 1.25rem;
    }

    .logo svg {
      color: var(--primary);
      width: 32px;
      height: 32px;
    }

    .nav {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }

    .nav a {
      text-decoration: none;
      color: var(--text-muted);
      font-size: 0.9rem;
      font-weight: 500;
      transition: color 0.2s;
    }

    .nav a:hover {
      color: var(--primary);
    }

    .btn-subscribe {
      background-color: var(--primary);
      color: white !important;
      padding: 0.5rem 1.25rem;
      border-radius: 9999px;
      font-weight: 600 !important;
    }

    .btn-subscribe:hover {
      background-color: var(--primary-dark);
      transform: translateY(-1px);
    }

    .container {
      max-width: 800px;
      margin: 3rem auto;
      padding: 0 1.5rem;
      flex-grow: 1;
    }

    /* Overall Status Card */
    .status-hero {
      background-color: var(--card-bg);
      border-radius: var(--radius);
      padding: 2.5rem;
      text-align: center;
      box-shadow: var(--shadow-lg);
      margin-bottom: 3rem;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .status-hero::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background-color: var(--status-color, var(--primary));
    }

    .status-hero h1 {
      font-size: 1.875rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    .status-hero p {
      color: var(--text-muted);
      font-size: 1rem;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1.25rem;
      border-radius: 9999px;
      font-weight: 600;
      font-size: 0.875rem;
      margin-top: 1.5rem;
      background-color: var(--status-bg, var(--success-bg));
      color: var(--status-color, var(--success));
    }

    /* Pulse animation */
    .pulse {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: currentColor;
      box-shadow: 0 0 0 0 rgba(var(--status-color-rgb, 16, 185, 129), 0.7);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(var(--status-color-rgb, 16, 185, 129), 0.7);
      }

      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(var(--status-color-rgb, 16, 185, 129), 0);
      }

      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(var(--status-color-rgb, 16, 185, 129), 0);
      }
    }

    /* Service Cards */
    .services-grid {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .service-card {
      background-color: var(--card-bg);
      border-radius: var(--radius);
      padding: 1.5rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .service-card:hover {
      box-shadow: var(--shadow-lg);
    }

    .service-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .service-info h3 {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .service-info p {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .service-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
    }

    .service-badge.operational {
      background-color: var(--success-bg);
      color: var(--success);
    }

    .service-badge.degraded {
      background-color: var(--warning-bg);
      color: var(--warning);
    }

    .service-badge.outage {
      background-color: var(--danger-bg);
      color: var(--danger);
    }

    /* Uptime Visualization */
    .uptime-viz {
      margin-top: 1.25rem;
    }

    .uptime-bar {
      display: flex;
      gap: 3px;
      height: 38px;
    }

    .uptime-stick {
      flex: 1;
      border-radius: 2px;
      position: relative;
      background-color: #E2E8F0;
      transition: all 0.2s;
    }

    [data-theme="dark"] .uptime-stick {
      background-color: #334155;
    }

    .uptime-stick.operational {
      background-color: var(--success);
    }

    .uptime-stick.degraded {
      background-color: var(--warning);
    }

    .uptime-stick.outage {
      background-color: var(--danger);
    }

    .uptime-stick:hover {
      transform: scaleY(1.1);
      z-index: 10;
    }

    .uptime-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
      font-size: 0.7rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .uptime-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border);
      margin-top: 0.75rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .uptime-pct {
      font-weight: 600;
      color: var(--text-main);
    }

    /* Tooltip */
    .tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background-color: var(--text-main);
      color: var(--bg);
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: all 0.2s;
      z-index: 100;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .uptime-stick:hover .tooltip {
      opacity: 1;
      transform: translateX(-50%) translateY(-12px);
    }

    /* Incidents & Maintenance */
    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin: 3rem 0 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .incident-item {
      background-color: var(--card-bg);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 1rem;
      border-left: 4px solid var(--info);
      box-shadow: var(--shadow);
    }

    .incident-item.critical {
      border-left-color: var(--danger);
    }

    .incident-item.resolved {
      border-left-color: var(--success);
    }

    .incident-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }

    .incident-title {
      font-weight: 600;
      font-size: 1.05rem;
    }

    .incident-date {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .incident-body {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    /* Footer */
    .footer {
      padding: 4rem 2rem;
      text-align: center;
      border-top: 1px solid var(--border);
      background-color: var(--card-bg);
    }

    .footer p {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .footer a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }

      .nav {
        gap: 1rem;
      }

      .status-hero {
        padding: 1.5rem;
      }

      .uptime-bar {
        gap: 1px;
      }
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-content">
      <a href="/status" class="logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
          stroke-linejoin="round">
          <path
            d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z">
          </path>
          <path d="M14.05 2a9 9 0 0 1 8 8" opacity="0.3"></path>
          <path d="M14.05 5a6 6 0 0 1 5 5" opacity="0.6"></path>
        </svg>
        WhatsBenemax
      </a>
      <nav class="nav">
        <a href="/status">Histórico</a>
        <a href="/status/maintenance">Manutenções</a>
        <a href="/status/subscribe" class="btn-subscribe">Receber Alertas</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="status-hero" id="statusHero">
      <h1 id="overallTitle">Verificando sistema...</h1>
      <p id="overallSubtitle">Aguarde um momento enquanto carregamos os dados em tempo real.</p>
      <div class="status-indicator" id="overallIndicator">
        <span class="pulse"></span>
        <span id="overallBadge">Sincronizando</span>
      </div>
    </section>

    <div id="activeIncidents"></div>

    <!-- Diagnóstico em Tempo Real -->
    <div id="diagnosticsSection" style="display: none; margin-bottom: 2rem;">
      <h2 class="section-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
        Saúde do Servidor
      </h2>
      <div class="service-card" style="padding: 1rem; display: flex; gap: 2rem; align-items: center; flex-wrap: wrap;">
        <div class="stat-item">
          <small style="color: var(--text-muted); display: block;">Memória RSS</small>
          <strong id="statMemory" style="font-size: 1.25rem;">-- MB</strong>
        </div>
        <div class="stat-item">
          <small style="color: var(--text-muted); display: block;">Heap Usado</small>
          <strong id="statHeap" style="font-size: 1.25rem;">-- MB</strong>
        </div>
        <div class="stat-item">
          <small style="color: var(--text-muted); display: block;">Livre no Sistema</small>
          <strong id="statFree" style="font-size: 1.25rem;">-- MB</strong>
        </div>
      </div>
    </div>

    <h2 class="section-title">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
        <line x1="6" y1="6" x2="6.01" y2="6"></line>
        <line x1="6" y1="18" x2="6.01" y2="18"></line>
      </svg>
      Componentes do Sistema
    </h2>

    <div class="services-grid" id="servicesGrid">
      <!-- Loading skeletons -->
      <div class="service-card" style="height: 160px; opacity: 0.5;"></div>
      <div class="service-card" style="height: 160px; opacity: 0.3;"></div>
    </div>

    <h2 class="section-title">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
      </svg>
      Incidentes Recentes
    </h2>
    <div id="incidentHistory"></div>

    <div id="disconnectedSection" style="display: none; margin-top: 3rem;">
      <h2 class="section-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
          <line x1="12" y1="2" x2="12" y2="12"></line>
        </svg>
        Instâncias Offline (Últimas 24h)
      </h2>
      <div id="disconnectedGrid" class="services-grid"></div>
    </div>
  </main>

  <footer class="footer">
    <p>© 2026 WhatsBenemax. Todos os direitos reservados.</p>
    <p style="margin-top: 5px;">Monitorado em tempo real · <a href="/status/rss">RSS Feed</a></p>
  </footer>

  <script>
    const STATUS_MAP = {
      operational: { label: 'Operacional', color: '#10B981', rgb: '16, 185, 129', bg: '#ECFDF5', hero: 'Sistemas Operacionais', sub: 'Tudo funcionando perfeitamente em nosso ecossistema.' },
      degraded: { label: 'Instabilidade', color: '#F59E0B', rgb: '245, 158, 11', bg: '#FFFBEB', hero: 'Algumas instabilidades', sub: 'Estamos cientes e trabalhando para normalizar a operação.' },
      outage: { label: 'Interrupção', color: '#EF4444', rgb: '239, 68, 68', bg: '#FEF2F2', hero: 'Interrupção Parcial', sub: 'Detectamos uma falha crítica. Nossa equipe já está atuando.' },
      maintenance: { label: 'Manutenção', color: '#3B82F6', rgb: '59, 130, 246', bg: '#EFF6FF', hero: 'Manutenção Agendada', sub: 'Estamos realizando melhorias programadas no sistema.' }
    };

    async function fetchData() {
      try {
        const [currentRes, incidentsRes] = await Promise.all([
          fetch('/status/api/current'),
          fetch('/status/api/incidents?limit=5')
        ]);

        const current = await currentRes.json();
        const incidents = await incidentsRes.json();

        updateOverall(current.overall);
        renderServices(current.services);
        renderIncidents(incidents.incidents);
        renderDiagnostics(current.telemetry, current.disconnectedInstances);

      } catch (err) {
        console.error('Fetch error:', err);
      }
    }

    function updateOverall(status) {
      const config = STATUS_MAP[status] || STATUS_MAP.operational;
      const hero = document.getElementById('statusHero');
      const badge = document.getElementById('overallBadge');
      const title = document.getElementById('overallTitle');
      const subtitle = document.getElementById('overallSubtitle');

      hero.style.setProperty('--status-color', config.color);
      hero.style.setProperty('--status-bg', config.bg);
      hero.style.setProperty('--status-color-rgb', config.rgb);

      title.textContent = config.hero;
      subtitle.textContent = config.sub;
      badge.textContent = config.label;
    }

    async function renderServices(services) {
      const grid = document.getElementById('servicesGrid');
      grid.innerHTML = '';

      for (const service of services) {
        const card = document.createElement('div');
        card.className = 'service-card';

        // Fetch history for this service
        let history = [];
        let uptimePct = 100;
        try {
          const res = await fetch(`/status/api/history/${service.slug}?days=45`);
          const data = await res.json();
          history = data.history;
          uptimePct = data.uptime;
        } catch (e) { }

        const sticks = [];
        const now = new Date();
        for (let i = 44; i >= 0; i--) {
          const d = new Date(); d.setDate(now.getDate() - i);
          const dStr = d.toISOString().split('T')[0];
          const entry = history.find(h => h.date.split('T')[0] === dStr);

          let state = 'no-data';
          let tip = d.toLocaleDateString('pt-BR');

          if (entry) {
            const pct = parseFloat(entry.uptime_percentage);
            state = pct >= 99.9 ? 'operational' : pct > 90 ? 'degraded' : 'outage';
            tip += ` · ${pct.toFixed(2)}% Uptime`;
          }

          sticks.push(`<div class="uptime-stick ${state}"><div class="tooltip">${tip}</div></div>`);
        }

        card.innerHTML = `
          <div class="service-header">
            <div class="service-info">
              <h3>${service.name}</h3>
              <p>${service.description || 'Monitoramento core'}</p>
            </div>
            <div class="service-badge ${service.status}">
              <div class="pulse" style="width: 6px; height: 6px;"></div>
              ${STATUS_MAP[service.status]?.label || 'Desconhecido'}
            </div>
          </div>
          <div class="uptime-viz">
            <div class="uptime-bar">${sticks.join('')}</div>
            <div class="uptime-footer">
              <span>45 dias atrás</span>
              <span>100% Uptime</span>
              <span>Hoje</span>
            </div>
          </div>
          <div class="uptime-summary">
            <span>Uptime 45 dias</span>
            <span class="uptime-pct">${parseFloat(uptimePct).toFixed(3)}%</span>
          </div>
        `;
        grid.appendChild(card);
      }
    }

    function renderIncidents(incidents) {
      const history = document.getElementById('incidentHistory');
      if (!incidents || incidents.length === 0) {
        history.innerHTML = '<div style="text-align:center; padding: 2rem; color: var(--text-muted); border: 1px dashed var(--border); border-radius: 12px;">Nenhum incidente relatado nos últimos meses.</div>';
        return;
      }

      history.innerHTML = incidents.map(i => `
        <div class="incident-item ${i.status === 'resolved' ? 'resolved' : i.severity}">
          <div class="incident-header">
            <span class="incident-title">${i.title}</span>
            <span class="incident-date">${new Date(i.started_at).toLocaleDateString('pt-BR')}</span>
          </div>
          <p class="incident-body">${i.description}</p>
        </div>
      `).join('');
    }

    function renderDiagnostics(telemetry, disconnected) {
      if (telemetry) {
        document.getElementById('diagnosticsSection').style.display = 'block';
        document.getElementById('statMemory').textContent = telemetry.rss + ' MB';
        document.getElementById('statHeap').textContent = telemetry.heapUsed + ' MB';
        document.getElementById('statFree').textContent = telemetry.freeSystem + ' MB';
      }

      if (disconnected && disconnected.length > 0) {
        document.getElementById('disconnectedSection').style.display = 'block';
        const grid = document.getElementById('disconnectedGrid');
        grid.innerHTML = disconnected.map(inst => `
          <div class="service-card" style="padding: 1rem; border-left: 4px solid var(--danger);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <strong>${inst.instance_name}</strong>
              <small style="color: var(--text-muted);">Visto em: ${new Date(inst.updated_at).toLocaleString('pt-BR')}</small>
            </div>
          </div>
        `).join('');
      } else {
        document.getElementById('disconnectedSection').style.display = 'none';
      }
    }

    // Auto theme detection
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.setAttribute('data-theme', 'dark');
    }

    fetchData();
    setInterval(fetchData, 60000);
  </script>
</body>

</html>